<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>即时任务 - 艾兜兜儿</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --danger: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }
        .container { display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        
        /* 顶部 */
        .header { text-align: center; margin-bottom: 20px; }
        .avatar { width: 64px; height: 64px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
        .nickname { font-size: 17px; font-weight: 600; margin-top: 8px; }

        /* 卡片 */
        .card { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .task-group { margin-bottom: 15px; background: #f9f9f9; padding: 12px; border-radius: 14px; position: relative; }
        .input-wrapper { display: flex; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 8px; }
        input[type="text"] { flex: 1; border: none; background: transparent; padding: 8px 0; font-size: 16px; outline: none; }
        .clear-btn { padding: 5px; color: #ccc; cursor: pointer; display: none; font-size: 18px; }
        input[type="text"]:not(:placeholder-shown) + .clear-btn { display: block; }
        .time-wrapper { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #888; }
        input[type="time"] { border: 1px solid #ddd; border-radius: 6px; padding: 3px 5px; font-family: inherit; }

        /* 按钮区 */
        .btn-main { width: 100%; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 12px; }
        #startBtn { background: var(--primary); color: white; }
        #startBtn.active { background: var(--danger); animation: pulse 2s infinite; }
        .btn-sub { background: #eee; color: #333; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* 分享模态框 */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:1000; overflow-y:auto; padding:20px; box-sizing:border-box; }
        .modal-content { background: #f2f2f7; width:100%; max-width:450px; border-radius:24px; padding:20px; }
        #previewImg { width:100%; border-radius:12px; margin-bottom:15px; background: white; }
        .edit-panel { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: left; }
        .edit-panel label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
        .edit-panel input { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }

        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #8e8e93; line-height: 2; }
        .link { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        #shareCanvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg" class="avatar" id="mainAvatar">
        <div class="nickname" id="mainNick">艾兜兜儿</div>
    </div>

    <div class="card">
        <div id="tasksContainer"></div>
        <button id="startBtn" class="btn-main" onclick="initAlarm()">开启立即执行监控</button>
        <button class="btn-main btn-sub" onclick="openShareModal()">预览分享卡片</button>
        <button class="btn-main btn-sub" onclick="copyLink()" style="background:#e8f2ff; color:var(--primary)">复制工具链接</button>
    </div>

    <div class="footer">
        「AI 提效官方群」<span class="link" onclick="copyQQ()">857023577</span><br>
        技术支持：<a href="https://t.zsxq.com/7tSuP" class="link">艾兜兜儿</a> | 
        更多：<a href="https://mp.weixin.qq.com/s/uHh9gx2sUMOOjIhKyIbx4A" class="link">点击进入</a><br>
        &copy; <span id="year"></span> 艾兜兜儿. All Rights Reserved.
    </div>
</div>

<div class="modal" id="shareModal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0">卡片预览与定制</h3>
        <img id="previewImg" src="" alt="预览生成中...">
        <div class="edit-panel">
            <label>自定义头像链接</label>
            <input type="text" id="editAvatar" placeholder="图片URL">
            <label>自定义昵称</label>
            <input type="text" id="editNick">
            <button class="btn-main" onclick="updatePreview()" style="background:#333; color:white; padding:10px;">刷新预览</button>
        </div>
        <button class="btn-main" onclick="downloadCard()" style="background:var(--primary); color:white;">保存卡片图片</button>
        <button class="link" style="margin-top:15px; display:block; width:100%; text-align:center;" onclick="closeModal()">返回修改任务</button>
    </div>
</div>

<canvas id="shareCanvas" width="600" height="1000"></canvas>
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" loop></audio>
<audio id="silentMode" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==/"></audio>

<script>
    let isMonitoring = false;
    let checkTimer = null;
    let notifiedTasks = new Set(); // 记录已提醒的任务

    window.onload = () => {
        document.getElementById('year').textContent = new Date().getFullYear();
        document.getElementById('editNick').value = document.getElementById('mainNick').innerText;
        document.getElementById('editAvatar').value = document.getElementById('mainAvatar').src;
        initTasks();
    };

    function initTasks() {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = '';
        const now = new Date();
        const saved = JSON.parse(localStorage.getItem('tasks_v4') || '[]');

        for (let i = 0; i < 3; i++) {
            const tDate = new Date(now.getTime() + (i + 1) * 5 * 60000);
            const defTime = `${String(tDate.getHours()).padStart(2,'0')}:${String(tDate.getMinutes()).padStart(2,'0')}`;
            const taskText = saved[i]?.text || (saved.length ? "" : `示例任务 ${i+1}`);
            const taskTime = saved[i]?.time || (saved.length ? "" : defTime);

            container.innerHTML += `
                <div class="task-group">
                    <div class="input-wrapper">
                        <input type="text" id="t${i}" maxlength="50" placeholder="任务内容..." value="${taskText}" oninput="saveData(${i})">
                        <span class="clear-btn" onclick="clearInput(${i})">✕</span>
                    </div>
                    <div class="time-wrapper">
                        <span>截止</span>
                        <input type="time" id="tm${i}" value="${taskTime}" onchange="saveData(${i})">
                    </div>
                </div>`;
        }
    }

    function clearInput(i) { document.getElementById('t'+i).value = ''; saveData(i); }
    
    function saveData(i) {
        // 当修改时间或内容时，清除该索引的“已提醒”标记，确保新时间能再次提醒
        notifiedTasks.delete(i + '_60');
        notifiedTasks.delete(i + '_timeout');
        
        const data = [0,1,2].map(idx => ({
            text: document.getElementById('t'+idx).value,
            time: document.getElementById('tm'+idx).value
        }));
        localStorage.setItem('tasks_v4', JSON.stringify(data));
    }

    // --- 提醒逻辑 ---
    async function initAlarm() {
        const beep = document.getElementById('beep');
        const silent = document.getElementById('silentMode');
        
        // 激活音频通道
        silent.play().catch(e => console.log("静音音频激活失败"));

        if (Notification.permission !== "granted") {
            await Notification.requestPermission();
        }

        isMonitoring = !isMonitoring;
        const btn = document.getElementById('startBtn');
        if(isMonitoring) {
            btn.innerText = "监控运行中 (保持后台)";
            btn.classList.add('active');
            checkTimer = setInterval(runCheck, 10000); // 提高检查频率至10秒
        } else {
            clearInterval(checkTimer);
            silent.pause();
            btn.innerText = "开启立即执行监控";
            btn.classList.remove('active');
        }
    }

    function runCheck() {
        const now = new Date();
        const curTotalMin = now.getHours() * 60 + now.getMinutes();
        
        for (let i = 0; i < 3; i++) {
            const text = document.getElementById('t'+i).value;
            const time = document.getElementById('tm'+i).value;
            if(!text || !time) continue;

            const [h, m] = time.split(':');
            const targetTotalMin = parseInt(h) * 60 + parseInt(m);
            const diff = targetTotalMin - curTotalMin;

            // 提前1小时预警
            if (diff === 60 && !notifiedTasks.has(i + '_60')) {
                sendAlert(`预警：任务 [${text}] 还有1小时截止！`);
                notifiedTasks.add(i + '_60');
            }

            // 到期及超时提醒 (每5分钟重复提醒)
            if (diff <= 0) {
                const overdue = Math.abs(diff);
                const mark = i + '_timeout_' + overdue;
                if (overdue % 5 === 0 && !notifiedTasks.has(mark)) {
                    sendAlert(`⚠️ 立即执行：[${text}]！${overdue === 0 ? '时间已到' : '已超时'+overdue+'分钟'}`, true);
                    notifiedTasks.add(mark);
                }
            }
        }
    }

    function sendAlert(msg, persistent = false) {
        if (Notification.permission === "granted") {
            new Notification("艾兜兜儿提醒", { 
                body: msg, 
                icon: 'https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg',
                requireInteraction: true 
            });
        }
        const beep = document.getElementById('beep');
        beep.currentTime = 0;
        beep.play();
        // 连续播放5次
        let count = 1;
        beep.onended = () => {
            if(count < 5) { count++; beep.play(); }
        };
    }

    // --- 分享系统 ---
    const canvas = document.getElementById('shareCanvas');
    const ctx = canvas.getContext('2d');

    async function updatePreview() {
        const nick = document.getElementById('editNick').value || "艾兜兜儿";
        const avatarSrc = document.getElementById('editAvatar').value;
        
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,600,1000);
        
        // 蓝色页眉
        ctx.fillStyle = "#007AFF";
        ctx.fillRect(0,0,600,280);

        // 绘制头像
        try {
            const avatarImg = new Image();
            avatarImg.crossOrigin = "anonymous";
            avatarImg.src = avatarSrc;
            await new Promise((res, rej) => { avatarImg.onload = res; avatarImg.onerror = res; });
            ctx.save();
            ctx.beginPath();
            ctx.arc(300, 110, 60, 0, Math.PI*2);
            ctx.clip();
            if(avatarImg.complete && avatarImg.naturalWidth > 0) {
                ctx.drawImage(avatarImg, 240, 50, 120, 120);
            } else {
                ctx.fillStyle = "#ccc"; ctx.fill();
            }
            ctx.restore();
        } catch(e) {}

        // 文字信息
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.font = "bold 36px sans-serif";
        ctx.fillText(nick, 300, 210);
        ctx.font = "24px sans-serif";
        ctx.fillText("邀请你一起专注任务", 300, 250);

        // 任务列表区
        ctx.textAlign = "left";
        ctx.fillStyle = "#f9f9fb";
        ctx.fillRect(40, 310, 520, 420);
        
        ctx.fillStyle = "#1c1c1e";
        for(let i=0; i<3; i++) {
            const txt = document.getElementById('t'+i).value || "未填写任务";
            const tm = document.getElementById('tm'+i).value || "--:--";
            ctx.font = "bold 30px sans-serif";
            ctx.fillText(`${i+1}. ${txt}`, 70, 380 + i*110);
            ctx.fillStyle = "#007AFF";
            ctx.font = "20px sans-serif";
            ctx.fillText(`⏰ 截止时刻: ${tm}`, 70, 420 + i*110);
            ctx.fillStyle = "#1c1c1e";
        }

        // 引流推广信息
        ctx.textAlign = "center";
        ctx.fillStyle = "#8e8e93";
        ctx.font = "bold 22px sans-serif";
        ctx.fillText("AI 驱动提效 · 专注每一分钟", 300, 770);

        // 二维码
        const qrUrl = await QRCode.toDataURL(window.location.href, { margin: 1, width: 150 });
        const qrImg = new Image();
        qrImg.src = qrUrl;
        await new Promise(res => qrImg.onload = res);
        ctx.drawImage(qrImg, 225, 800, 150, 150);
        ctx.font = "16px sans-serif";
        ctx.fillText("长按识别二维码体验工具", 300, 970);

        document.getElementById('previewImg').src = canvas.toDataURL("image/png");
    }

    function openShareModal() {
        document.getElementById('shareModal').style.display = 'flex';
        updatePreview();
    }
    function closeModal() { document.getElementById('shareModal').style.display = 'none'; }
    function downloadCard() {
        const link = document.createElement('a');
        link.download = '艾兜兜儿提效卡片.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        alert("工具链接已复制！");
    }
    function copyQQ() {
        navigator.clipboard.writeText('857023577');
        alert("QQ群号已复制！");
    }
</script>
</body>
</html>
