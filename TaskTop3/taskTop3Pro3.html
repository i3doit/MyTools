<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>即时任务 - 艾兜兜儿</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --danger: #ff3b30; }
        /* 修复无法滚动问题 */
        html, body { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }
        
        .container { display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        
        /* 主页头部 */
        .header { text-align: center; margin-bottom: 20px; }
        .avatar-main { width: 64px; height: 64px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
        .nick-main { font-size: 17px; font-weight: 600; margin-top: 8px; color: #333; }

        /* 任务卡片 */
        .card { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .task-group { margin-bottom: 15px; background: #f9f9f9; padding: 12px; border-radius: 14px; position: relative; }
        .input-row { display: flex; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 8px; }
        input[type="text"] { flex: 1; border: none; background: transparent; padding: 8px 0; font-size: 16px; outline: none; }
        .clear-btn { padding: 5px; color: #ccc; cursor: pointer; display: none; font-size: 18px; }
        input[type="text"]:not(:placeholder-shown) + .clear-btn { display: block; }
        .time-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #888; }
        input[type="time"] { border: 1px solid #ddd; border-radius: 6px; padding: 3px 5px; background: white; }

        /* 按钮 */
        .btn-main { width: 100%; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 12px; }
        #startBtn { background: var(--primary); color: white; transition: 0.3s; }
        #startBtn.active { background: var(--danger); animation: pulse 2s infinite; }
        .btn-sub { background: #eee; color: #333; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* 模态框重构 */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:flex-start; z-index:2000; overflow-y:auto; padding:20px 10px; box-sizing:border-box; }
        .modal-content { background: #f2f2f7; width:100%; max-width:420px; border-radius:24px; padding:15px; box-sizing: border-box; margin-bottom: 40px;}
        
        /* 预览卡片样式 - 参考上传图 */
        .preview-card { background: #ecf9eb; border-radius: 20px; padding: 25px; text-align: center; position: relative; overflow: hidden; margin-bottom: 20px;}
        .preview-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .preview-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; cursor: pointer; object-fit: cover; background: #eee;}
        .preview-nick { margin-top: 10px; font-size: 24px; font-weight: bold; border: none; background: transparent; text-align: center; width: 100%; outline: none; color: #333; }
        .preview-sub { color: #888; font-size: 14px; margin-bottom: 20px; }
        
        .qr-box { background: white; border-radius: 15px; padding: 20px; display: inline-block; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .qr-placeholder { width: 200px; height: 200px; display: block; }
        .preview-footer { font-size: 16px; color: #444; margin-top: 10px; }

        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #8e8e93; line-height: 2; }
        .link { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        #shareCanvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg" class="avatar-main" id="displayAvatar">
        <div class="nick-main" id="displayNick">艾兜兜儿</div>
    </div>

    <div class="card">
        <div id="tasksContainer"></div>
        <button id="startBtn" class="btn-main" onclick="handleStart()">开启强力提醒模式</button>
        <button class="btn-main btn-sub" onclick="openShareModal()">生成分享卡片</button>
        <button class="btn-main btn-sub" onclick="copyLink()" style="background:#e8f2ff; color:var(--primary)">复制工具链接</button>
    </div>

    <div class="footer">
        「AI 提效官方群」<span class="link" onclick="copyQQ()">857023577</span><br>
        技术支持：<a href="https://t.zsxq.com/7tSuP" class="link">艾兜兜儿</a><br>
        &copy; <span id="year"></span> 艾兜兜儿. All Rights Reserved.
    </div>
</div>

<div class="modal" id="shareModal">
    <div class="modal-content">
        <div class="preview-card" id="captureArea">
            <div class="preview-header">
                <img src="https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg" class="preview-avatar" id="editAvatarImg" onclick="changeAvatar()" title="点击修改头像">
                <input type="text" class="preview-nick" id="editNickInput" value="艾兜兜儿" maxlength="10">
                <div class="preview-sub">邀你一起使用</div>
            </div>
            
            <div class="qr-box">
                <canvas id="qrCanvas" class="qr-placeholder"></canvas>
            </div>
            
            <div class="preview-footer">扫码发现更多精彩内容</div>
        </div>

        <button class="btn-main" onclick="downloadCard()" style="background:var(--primary); color:white;">保存分享卡片</button>
        <button class="link" style="margin-top:15px; display:block; width:100%; text-align:center;" onclick="closeModal()">返回修改任务</button>
    </div>
</div>

<canvas id="shareCanvas" width="600" height="900"></canvas>
<audio id="alertAudio" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="keepAlive" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==/"></audio>

<script>
    let isMonitoring = false;
    let checkInterval = null;
    let notifiedSet = new Set();

    window.onload = () => {
        document.getElementById('year').textContent = new Date().getFullYear();
        initTasks();
    };

    function initTasks() {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = '';
        const saved = JSON.parse(localStorage.getItem('aidoudou_tasks_v6') || '[]');

        for (let i = 0; i < 3; i++) {
            const text = saved[i]?.text || "";
            const time = saved[i]?.time || "";
            container.innerHTML += `
                <div class="task-group">
                    <div class="input-row">
                        <input type="text" id="t${i}" placeholder="最重要的任务..." value="${text}" oninput="updateData(${i})">
                        <span class="clear-btn" onclick="clearInput(${i})">✕</span>
                    </div>
                    <div class="time-row">
                        <span>截止</span>
                        <input type="time" id="tm${i}" value="${time}" onchange="updateData(${i})">
                    </div>
                </div>`;
        }
    }

    function clearInput(i) { document.getElementById('t'+i).value = ''; updateData(i); }

    function updateData(i) {
        notifiedSet.delete(i + '_60');
        notifiedSet.delete(i + '_0');
        const data = [0,1,2].map(idx => ({
            text: document.getElementById('t'+idx).value,
            time: document.getElementById('tm'+idx).value
        }));
        localStorage.setItem('aidoudou_tasks_v6', JSON.stringify(data));
    }

    // --- 修复按钮无响应问题 ---
    async function handleStart() {
        const alertAudio = document.getElementById('alertAudio');
        const keepAlive = document.getElementById('keepAlive');
        
        // 尝试播放一次以解除 iOS 音频锁定
        alertAudio.play().then(() => alertAudio.pause()).catch(() => {});
        keepAlive.play().catch(() => {});

        // 请求通知权限
        if (Notification.permission !== "granted") {
            const permission = await Notification.requestPermission();
            if(permission !== "granted") {
                alert("请允许通知权限，否则锁屏时无法收到提醒。");
                return;
            }
        }

        toggleMonitor();
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btn = document.getElementById('startBtn');
        const keepAlive = document.getElementById('keepAlive');

        if(isMonitoring) {
            btn.innerText = "监控运行中 (锁屏有效)";
            btn.classList.add('active');
            keepAlive.play();
            checkInterval = setInterval(monitorLogic, 10000);
            alert("开启成功！请确保手机未处于静音模式，并将本页添加到主屏幕使用效果更佳。");
        } else {
            clearInterval(checkInterval);
            keepAlive.pause();
            btn.innerText = "开启强力提醒模式";
            btn.classList.remove('active');
        }
    }

    function monitorLogic() {
        const now = new Date();
        const nowMin = now.getHours() * 60 + now.getMinutes();
        for (let i = 0; i < 3; i++) {
            const text = document.getElementById('t'+i).value;
            const time = document.getElementById('tm'+i).value;
            if(!text || !time) continue;
            const [h, m] = time.split(':');
            const target = parseInt(h) * 60 + parseInt(m);
            const diff = target - nowMin;

            if (diff === 0 && !notifiedSet.has(i+'_0')) {
                triggerAlert(`⏰ 任务时间到：${text}`);
                notifiedSet.add(i+'_0');
            }
        }
    }

    function triggerAlert(msg) {
        new Notification("专注提醒", { body: msg });
        const audio = document.getElementById('alertAudio');
        audio.currentTime = 0;
        audio.play();
    }

    // --- 分享卡片直接编辑逻辑 ---
    function openShareModal() {
        document.getElementById('shareModal').style.display = 'flex';
        // 生成当前页面二维码
        QRCode.toCanvas(document.getElementById('qrCanvas'), window.location.href, {
            width: 200,
            margin: 1,
            color: { dark: "#000000", light: "#ffffff" }
        });
    }

    function changeAvatar() {
        const newUrl = prompt("请输入新的头像图片链接：", document.getElementById('editAvatarImg').src);
        if(newUrl) {
            document.getElementById('editAvatarImg').src = newUrl;
        }
    }

    function downloadCard() {
        const canvas = document.getElementById('shareCanvas');
        const ctx = canvas.getContext('2d');
        const nick = document.getElementById('editNickInput').value;
        const avatar = document.getElementById('editAvatarImg');
        const qr = document.getElementById('qrCanvas');

        // 绘制逻辑
        ctx.fillStyle = "#ecf9eb";
        ctx.fillRect(0,0,600,900);

        // 头像
        ctx.save();
        ctx.beginPath();
        ctx.arc(300, 150, 70, 0, Math.PI*2);
        ctx.clip();
        ctx.drawImage(avatar, 230, 80, 140, 140);
        ctx.restore();

        // 昵称
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.font = "bold 45px sans-serif";
        ctx.fillText(nick, 300, 290);
        
        ctx.font = "24px sans-serif";
        ctx.fillStyle = "#888";
        ctx.fillText("邀你一起使用", 300, 340);

        // 二维码区域
        ctx.fillStyle = "white";
        roundRect(ctx, 150, 400, 300, 300, 20);
        ctx.fill();
        ctx.drawImage(qr, 175, 425, 250, 250);

        ctx.fillStyle = "#444";
        ctx.font = "30px sans-serif";
        ctx.fillText("扫码发现更多精彩内容", 300, 780);

        // 触发下载
        const link = document.createElement('a');
        link.download = '分享卡片.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x+r, y); ctx.arcTo(x+w, y, x+w, y+h, r);
        ctx.arcTo(x+w, y+h, x, y+h, r); ctx.arcTo(x, y+h, x, y, r);
        ctx.arcTo(x, y, x+w, y, r); ctx.closePath();
    }

    function closeModal() { document.getElementById('shareModal').style.display = 'none'; }
    function copyLink() { navigator.clipboard.writeText(window.location.href); alert("链接已复制"); }
    function copyQQ() { navigator.clipboard.writeText('857023577'); alert("群号已复制"); }
</script>
</body>
</html>
