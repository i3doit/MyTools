<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>即时任务执行 - 艾兜兜儿</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --danger: #ff3b30; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1c1c1e; line-height: 1.5; }
        
        /* 布局控制 */
        .container { display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
        
        /* 主页头部 */
        .header { text-align: center; margin-bottom: 20px; padding-top: 20px; }
        .avatar-main { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); object-fit: cover; }
        .nick-main { font-size: 18px; font-weight: bold; margin-top: 10px; }

        /* 任务清单卡片 */
        .card { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .task-item { background: #f9f9fb; border-radius: 16px; padding: 15px; margin-bottom: 12px; position: relative; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #eee; }
        .task-input { flex: 1; border: none; background: transparent; padding: 10px 0; font-size: 16px; outline: none; }
        .clear-btn { color: #ccc; font-size: 20px; padding: 5px; display: none; cursor: pointer; }
        .task-input:not(:placeholder-shown) + .clear-btn { display: block; }
        
        .time-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #8e8e93; }
        input[type="time"] { border: 1px solid #ddd; border-radius: 8px; padding: 5px 8px; background: white; font-family: inherit; font-size: 14px; }

        /* 按钮组 */
        .btn-group { width: 100%; max-width: 400px; margin-top: 10px; }
        .btn { width: 100%; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 12px; transition: all 0.2s; }
        #startBtn { background: var(--primary); color: white; }
        #startBtn.active { background: var(--danger); animation: breathe 2s infinite; }
        .btn-sub { background: white; color: #1c1c1e; border: 1px solid #ddd; }
        
        @keyframes breathe { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* 深度定制分享模态框 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 999; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px 15px; }
        .modal-body { width: 100%; max-width: 420px; margin: 0 auto; }
        
        /* 预览卡片视觉 */
        .preview-card { background: white; border-radius: 28px; overflow: hidden; position: relative; padding: 30px 20px; }
        .preview-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .p-avatar { width: 85px; height: 85px; border-radius: 50%; border: 4px solid #f2f2f7; object-fit: cover; cursor: pointer; }
        .p-nick { border: none; background: transparent; font-size: 24px; font-weight: bold; text-align: center; margin-top: 12px; width: 100%; outline: none; }
        .p-invite { color: #8e8e93; font-size: 14px; margin-top: 4px; }

        .p-title-box { text-align: left; margin: 20px 0; border-left: 4px solid var(--primary); padding-left: 15px; }
        .p-main-title { font-size: 22px; font-weight: bold; display: block; }
        .p-sub-title { font-size: 14px; color: var(--primary); font-weight: 500; }

        .p-task-list { text-align: left; margin-bottom: 30px; }
        .p-task-item { font-size: 17px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        .p-task-time { color: var(--primary); font-weight: bold; font-size: 14px; }

        .p-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f2f2f7; }
        .p-support { text-align: left; }
        .p-support b { font-size: 15px; display: block; color: #1c1c1e; }
        .p-support span { font-size: 12px; color: #8e8e93; }
        .qr-area canvas { width: 90px !important; height: 90px !important; }

        /* 底部 */
        .footer { margin-top: auto; padding: 30px 0; text-align: center; font-size: 12px; color: #8e8e93; }
        .link { color: var(--primary); text-decoration: none; cursor: pointer; font-weight: 500; }
        
        #hiddenCanvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <img src="https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg" class="avatar-main" id="mainAvatar">
        <div class="nick-main" id="mainNick">艾兜兜儿</div>
    </header>

    <main class="card">
        <div id="tasksContainer"></div>
        <div class="btn-group">
            <button id="startBtn" class="btn" onclick="handleStartToggle()">开启强力提醒模式</button>
            <button class="btn btn-sub" onclick="openShareModal()">生成分享卡片</button>
            <button class="btn btn-sub" style="background: transparent;" onclick="copyLink()">复制链接分享给好友</button>
        </div>
    </main>

    <footer class="footer">
        「AI 提效官方群」<span class="link" onclick="copyContent('857023577')">857023577</span><br>
        技术支持：<a href="https://t.zsxq.com/7tSuP" class="link">艾兜兜儿</a> | <span id="year"></span>
    </footer>
</div>

<div class="modal" id="shareModal">
    <div class="modal-body">
        <div class="preview-card" id="captureArea">
            <div class="preview-header">
                <img src="" class="p-avatar" id="pAvatar" onclick="changeAvatar()" title="点击更换头像">
                <input type="text" class="p-nick" id="pNick" maxlength="12">
                <div class="p-invite">邀请你一起专注任务</div>
            </div>

            <div class="p-title-box">
                <span class="p-main-title">今日最重要的三件事</span>
                <span class="p-sub-title">专注执行 · 拒绝拖延</span>
            </div>

            <div class="p-task-list" id="pTaskList"></div>

            <div class="p-footer">
                <div class="p-support">
                    <b>技术支持：艾兜兜儿</b>
                    <span>AI 驱动效能，让专注更简单</span>
                </div>
                <div class="qr-area">
                    <canvas id="qrCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <button class="btn" onclick="downloadImage()" style="background:var(--primary); color:white; margin-top:20px;">保存分享图片</button>
        <button class="btn btn-sub" style="background:rgba(255,255,255,0.2); color:white; border:none;" onclick="closeModal()">返回修改</button>
    </div>
</div>

<canvas id="hiddenCanvas" width="600" height="1000"></canvas>
<audio id="beepAudio" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="silentAudio" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==/"></audio>

<script>
    let isMonitoring = false;
    let timer = null;
    let notifiedSet = new Set();
    const defaultAvatar = "https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg";
    const defaultNick = "艾兜兜儿";

    window.onload = () => {
        document.getElementById('year').textContent = '© ' + new Date().getFullYear() + ' 艾兜兜儿';
        loadTasks();
    };

    // --- 任务管理 ---
    function loadTasks() {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = '';
        const saved = JSON.parse(localStorage.getItem('aidoudou_v7') || '[]');
        const now = new Date();

        for (let i = 0; i < 3; i++) {
            const tDate = new Date(now.getTime() + (i + 1) * 5 * 60000);
            const defTime = `${String(tDate.getHours()).padStart(2,'0')}:${String(tDate.getMinutes()).padStart(2,'0')}`;
            
            const text = saved[i]?.text || (saved.length ? "" : `示例任务 ${i+1}`);
            const time = saved[i]?.time || (saved.length ? "" : defTime);

            container.innerHTML += `
                <div class="task-item">
                    <div class="input-row">
                        <input type="text" class="task-input" id="t${i}" placeholder="输入任务目标..." value="${text}" oninput="sync(${i})">
                        <span class="clear-btn" onclick="clearTask(${i})">✕</span>
                    </div>
                    <div class="time-row">
                        <span>截止时间</span>
                        <input type="time" id="tm${i}" value="${time}" onchange="sync(${i})">
                    </div>
                </div>`;
        }
    }

    function clearTask(i) { document.getElementById('t'+i).value = ''; sync(i); }

    function sync(i) {
        notifiedSet.delete(i + '_0'); // 修改时间后重置状态
        const data = [0,1,2].map(idx => ({
            text: document.getElementById('t'+idx).value,
            time: document.getElementById('tm'+idx).value
        }));
        localStorage.setItem('aidoudou_v7', JSON.stringify(data));
    }

    // --- 提醒功能 (修复按钮无响应) ---
    async function handleStartToggle() {
        const btn = document.getElementById('startBtn');
        const beep = document.getElementById('beepAudio');
        const silent = document.getElementById('silentAudio');

        // 1. 立即激活音频对象 (iOS 必须在点击流中执行)
        beep.play().then(() => beep.pause()).catch(() => {});
        
        if (!isMonitoring) {
            // 2. 请求权限
            if (Notification.permission !== "granted") {
                const res = await Notification.requestPermission();
                if (res !== "granted") {
                    alert("请开启通知权限，否则锁屏时无法收到提醒");
                    return;
                }
            }
            
            // 3. 开启监控
            isMonitoring = true;
            btn.innerText = "监控运行中 (点击关闭)";
            btn.classList.add('active');
            silent.play(); // 静音保活
            timer = setInterval(checkTasks, 10000);
            alert("开启成功！请将本网页【添加到主屏幕】使用效果最佳。");
        } else {
            // 停止监控
            isMonitoring = false;
            btn.innerText = "开启强力提醒模式";
            btn.classList.remove('active');
            silent.pause();
            clearInterval(timer);
        }
    }

    function checkTasks() {
        const now = new Date();
        const curTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        for (let i = 0; i < 3; i++) {
            const text = document.getElementById('t'+i).value;
            const time = document.getElementById('tm'+i).value;
            if (!text || !time) continue;

            if (curTime === time && !notifiedSet.has(i + '_0')) {
                sendAlert(`⏰ 任务时间到：${text}`);
                notifiedSet.add(i + '_0');
            }
        }
    }

    function sendAlert(msg) {
        new Notification("艾兜兜儿专注提醒", { body: msg, icon: defaultAvatar });
        const beep = document.getElementById('beepAudio');
        beep.currentTime = 0;
        beep.play();
        // 连续响铃 3 次增强感知
        let count = 1;
        beep.onended = () => { if(count < 3) { count++; beep.play(); } };
    }

    // --- 分享系统 (所见即所得) ---
    function openShareModal() {
        document.getElementById('pAvatar').src = document.getElementById('mainAvatar').src;
        document.getElementById('pNick').value = document.getElementById('mainNick').innerText;
        
        const listContainer = document.getElementById('pTaskList');
        listContainer.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const text = document.getElementById('t'+i).value || "未安排任务";
            const time = document.getElementById('tm'+i).value || "--:--";
            listContainer.innerHTML += `
                <div class="p-task-item">
                    <span>${i+1}. ${text}</span>
                    <span class="p-task-time">${time}</span>
                </div>`;
        }

        QRCode.toCanvas(document.getElementById('qrCanvas'), window.location.href, { margin: 1 });
        document.getElementById('shareModal').style.display = 'block';
    }

    function changeAvatar() {
        const url = prompt("请输入头像图片链接:", document.getElementById('pAvatar').src);
        if (url) document.getElementById('pAvatar').src = url;
    }

    function closeModal() { document.getElementById('shareModal').style.display = 'none'; }

    async function downloadImage() {
        const canvas = document.getElementById('hiddenCanvas');
        const ctx = canvas.getContext('2d');
        const card = document.getElementById('captureArea');
        
        // 模拟绘制复杂Canvas（为了传播质量）
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,600,1000);
        
        // 由于直接转DOM图片在部分浏览器不兼容，此处采用 Canvas 重绘
        ctx.fillStyle = "#1c1c1e";
        ctx.font = "bold 40px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("今日最重要的三件事", 300, 240);
        
        // 头像与昵称
        const av = new Image();
        av.crossOrigin = "anonymous";
        av.src = document.getElementById('pAvatar').src;
        await new Promise(r => av.onload = r);
        ctx.save();
        ctx.beginPath();
        ctx.arc(300, 100, 50, 0, Math.PI*2);
        ctx.clip();
        ctx.drawImage(av, 250, 50, 100, 100);
        ctx.restore();
        
        ctx.fillStyle = "#333";
        ctx.font = "bold 30px sans-serif";
        ctx.fillText(document.getElementById('pNick').value, 300, 180);

        // 任务绘制
        ctx.textAlign = "left";
        for (let i = 0; i < 3; i++) {
            const text = document.getElementById('t'+i).value || "未安排任务";
            const time = document.getElementById('tm'+i).value || "--:--";
            ctx.fillStyle = "#f2f2f7";
            ctx.fillRect(50, 320 + i*120, 500, 100);
            ctx.fillStyle = "#1c1c1e";
            ctx.font = "24px sans-serif";
            ctx.fillText(`${i+1}. ${text}`, 80, 375 + i*120);
            ctx.fillStyle = "#007AFF";
            ctx.fillText(time, 480, 375 + i*120);
        }

        const qrImg = new Image();
        qrImg.src = document.getElementById('qrCanvas').toDataURL();
        await new Promise(r => qrImg.onload = r);
        ctx.drawImage(qrImg, 450, 800, 100, 100);
        
        const link = document.createElement('a');
        link.download = 'aidoudou_share.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    function copyContent(text) {
        navigator.clipboard.writeText(text);
        alert("已复制：" + text);
    }
    function copyLink() { copyContent(window.location.href); }
    function copyQQ() { copyContent('857023577'); }
</script>
</body>
</html>
