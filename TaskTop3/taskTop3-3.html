<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>即时任务 - 艾兜兜儿</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --danger: #ff3b30; --gray: #8e8e93; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); -webkit-tap-highlight-color: transparent; }
        .container { display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .avatar { width: 64px; height: 64px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nickname { font-size: 17px; font-weight: 600; margin-top: 8px; color: #1c1c1e; }

        .card { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .task-group { margin-bottom: 12px; position: relative; background: #f9f9f9; padding: 12px; border-radius: 14px; }
        
        /* 输入框安全与清空按钮 */
        .input-wrapper { position: relative; display: flex; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        input[type="text"] { flex: 1; border: none; background: transparent; padding: 10px 30px 10px 0; font-size: 16px; outline: none; }
        .clear-btn { position: absolute; right: 5px; width: 18px; height: 18px; background: #ccc; color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        input[type="text"]:not(:placeholder-shown) + .clear-btn { display: flex; }

        .time-wrapper { display: flex; align-items: center; justify-content: space-between; font-size: 14px; color: var(--gray); }
        input[type="time"] { border: 1px solid #ddd; border-radius: 6px; padding: 4px 8px; font-family: inherit; -webkit-appearance: none; }

        .btn-main { width: 100%; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        #startBtn { background: var(--primary); color: white; }
        #startBtn.active { background: var(--danger); animation: pulse 2s infinite; }
        .btn-share { background: #f2f2f7; color: #1c1c1e; margin-top: 10px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .footer { margin-top: auto; padding: 30px 0; text-align: center; font-size: 12px; color: var(--gray); line-height: 1.8; }
        .link { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        #shareCanvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg" class="avatar" alt="艾兜兜儿">
        <div class="nickname">艾兜兜儿</div>
    </div>

    <div class="card" id="taskCard">
        <div id="tasksContainer">
            </div>

        <button id="startBtn" class="btn-main" onclick="initAlarm()">开启立即执行监控</button>
        <button class="btn-main btn-share" onclick="generateShareImage()">生成今日打卡图</button>
    </div>

    <div class="footer">
        「AI 提效官方群」<span class="link" onclick="copyText('857023577')">857023577</span><br>
        技术支持：<a href="https://t.zsxq.com/7tSuP" class="link">艾兜兜儿</a> | 
        更多：<a href="https://mp.weixin.qq.com/s/uHh9gx2sUMOOjIhKyIbx4A" class="link">点击进入</a><br>
        &copy; <span id="year"></span> 艾兜兜儿. All Rights Reserved.
    </div>
</div>

<canvas id="shareCanvas" width="600" height="900"></canvas>
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
    // --- 1. 后台入口预留 ---
    const API_CONFIG = {
        endpoint: "", // 此处填入后端接口地址
        autoSync: false
    };

    let isMonitoring = false;
    let checkTimer = null;

    // --- 2. 初始化逻辑 ---
    window.onload = () => {
        document.getElementById('year').textContent = new Date().getFullYear();
        renderTasks();
        loadSavedData();
    };

    function renderTasks() {
        const container = document.getElementById('tasksContainer');
        container.innerHTML = '';
        for (let i = 1; i <= 3; i++) {
            container.innerHTML += `
                <div class="task-group">
                    <label style="font-size:11px; color:#8e8e93">TASK 0${i}</label>
                    <div class="input-wrapper">
                        <input type="text" id="t${i}" maxlength="50" placeholder="任务内容 (选填)" oninput="saveData()">
                        <div class="clear-btn" onclick="clearInput(${i})">✕</div>
                    </div>
                    <div class="time-wrapper">
                        <span>截止时间</span>
                        <input type="time" id="tm${i}" onchange="saveData()">
                    </div>
                </div>`;
        }
    }

    // --- 3. 示例填充与数据安全 ---
    function loadSavedData() {
        const saved = localStorage.getItem('aidoudou_tasks');
        if (saved) {
            const data = JSON.parse(saved);
            inputIds().forEach((id, idx) => {
                if (data[id]) document.getElementById(id).value = data[id];
            });
        } else {
            fillDefaultExamples();
        }
    }

    function fillDefaultExamples() {
        const now = new Date();
        const examples = ["测试任务一 (即将提醒)", "测试任务二 (延后提醒)", "测试任务三"];
        for (let i = 1; i <= 3; i++) {
            const testDate = new Date(now.getTime() + (i * 5) * 60000);
            const h = String(testDate.getHours()).padStart(2, '0');
            const m = String(testDate.getMinutes()).padStart(2, '0');
            document.getElementById(`t${i}`).value = examples[i-1];
            document.getElementById(`tm${i}`).value = `${h}:${m}`;
        }
        saveData();
    }

    function clearInput(index) {
        document.getElementById(`t${index}`).value = '';
        saveData();
    }

    function saveData() {
        const data = {};
        inputIds().forEach(id => data[id] = document.getElementById(id).value);
        localStorage.setItem('aidoudou_tasks', JSON.stringify(data));
        // 这里可以调用 syncToBackend(data);
    }

    function inputIds() {
        return ['t1', 't2', 't3', 'tm1', 'tm2', 'tm3'];
    }

    // --- 4. 提醒逻辑优化 ---
    async function initAlarm() {
        const audio = document.getElementById('beep');
        audio.play().then(() => audio.pause()); // 激活 iOS 音频通道

        if (Notification.permission !== "granted") {
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("请在系统设置中允许通知，否则提醒将失效。");
                return;
            }
        }

        toggleMonitor();
    }

    function toggleMonitor() {
        const btn = document.getElementById('startBtn');
        isMonitoring = !isMonitoring;

        if (isMonitoring) {
            btn.innerText = "监控中... (点击关闭)";
            btn.classList.add('active');
            runCheck();
            checkTimer = setInterval(runCheck, 30000); // 30秒检查一次
        } else {
            clearInterval(checkTimer);
            btn.innerText = "开启立即执行监控";
            btn.classList.remove('active');
        }
    }

    function runCheck() {
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();

        for (let i = 1; i <= 3; i++) {
            const task = document.getElementById(`t${i}`).value;
            const time = document.getElementById(`tm${i}`).value;
            if (!task || !time) continue;

            const [h, m] = time.split(':');
            const targetMin = parseInt(h) * 60 + parseInt(m);
            const diff = targetMin - curMin;

            if (diff === 60) sendAlert(`任务 [${task}] 还有1小时截止！`);
            if (diff <= 0 && Math.abs(diff) % 5 === 0) {
                sendAlert(`⚠️ 立即执行：[${task}]！已超时！`, true);
            }
        }
    }

    function sendAlert(msg, loop = false) {
        new Notification("艾兜兜儿提醒", { body: msg, icon: 'https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg' });
        const audio = document.getElementById('beep');
        audio.currentTime = 0;
        audio.play();
    }

    function copyText(str) {
        navigator.clipboard.writeText(str).then(() => alert('QQ群号已复制：' + str));
    }

    // --- 5. 分享图合成 ---
    async function generateShareImage() {
        const canvas = document.getElementById('shareCanvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,600,900);
        
        ctx.fillStyle = '#1c1c1e';
        ctx.font = 'bold 36px sans-serif';
        ctx.fillText('艾兜兜儿 · 每日执行', 50, 80);

        ctx.font = '24px sans-serif';
        for(let i=1; i<=3; i++) {
            const text = document.getElementById(`t${i}`).value || '---';
            const time = document.getElementById(`tm${i}`).value || '--:--';
            ctx.fillStyle = '#333';
            ctx.fillText(`${i}. ${text}`, 50, 180 + (i*100));
            ctx.fillStyle = '#007AFF';
            ctx.font = '18px sans-serif';
            ctx.fillText(`截止时刻: ${time}`, 50, 215 + (i*100));
            ctx.font = '24px sans-serif';
        }

        const qrUrl = await QRCode.toDataURL(window.location.href);
        const img = new Image();
        img.src = qrUrl;
        img.onload = () => {
            ctx.drawImage(img, 400, 700, 150, 150);
            ctx.fillStyle = '#999';
            ctx.font = '16px sans-serif';
            ctx.fillText('扫码即用 · 提效神器', 410, 870);
            
            const dataUrl = canvas.toDataURL();
            const link = document.createElement('a');
            link.download = 'aidoudou_tasks.png';
            link.href = dataUrl;
            link.click();
        };
    }
</script>
</body>
</html>
