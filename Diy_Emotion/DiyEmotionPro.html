<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticker Studio - 聊天气泡设计器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500;700&display=swap');
        body { font-family: 'SF Pro Display', 'Noto Sans SC', sans-serif; background-color: #f5f5f7; color: #1d1d1f; }
        .apple-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.04); }
        .canvas-area { background-image: radial-gradient(#d2d2d7 1px, transparent 1px); background-size: 24px 24px; }
        textarea { resize: none; }
        .toggle-checkbox:checked { right: 0; border-color: #07C160; }
        .toggle-checkbox:checked + .toggle-label { background-color: #07C160; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <main class="max-w-6xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">表情包工作室</h1>
                <p class="text-gray-400 text-sm">Design your chat style with precision.</p>
            </div>
            <div class="hidden md:block text-right">
                <span class="text-xs bg-black text-white px-2 py-1 rounded">V2.0 PRO</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                
                <div class="apple-card p-6">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-widest uppercase">1. 内容配置</h3>
                    <textarea id="inputText" rows="3" 
                        class="w-full p-4 bg-gray-100 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition"
                        placeholder="输入文案，支持换行..." oninput="updateCanvas()">艾兜兜儿&#10;857023577</textarea>
                    
                    <div class="mt-4 flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <span class="text-sm font-medium">显示 I DO 装饰</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="showBadge" class="sr-only peer" onchange="updateCanvas()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>

                <div class="apple-card p-6">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-widest uppercase">2. 视觉样式</h3>
                    <div class="flex gap-3 mb-6">
                        <button onclick="changeColor('#07C160')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#07C160]"></button>
                        <button onclick="changeColor('#10aeff')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#10aeff]"></button>
                        <button onclick="changeColor('#333333')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#333333]"></button>
                        <input type="color" id="colorPicker" oninput="changeColor(this.value)" class="w-8 h-8 rounded-full cursor-pointer overflow-hidden border-none p-0">
                    </div>
                    
                    <label class="block w-full text-center py-3 border-2 border-dashed border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition">
                        <span class="text-sm text-gray-500 font-medium">更换头像图片</span>
                        <input type="file" class="hidden" accept="image/*" onchange="loadAvatar(event)">
                    </label>
                </div>

                <button onclick="downloadImage()" class="w-full py-4 bg-black text-white rounded-2xl font-bold hover:scale-[1.02] active:scale-95 transition-all shadow-xl">
                    导出高清表情包
                </button>
            </div>

            <div class="lg:col-span-8 flex flex-col gap-6">
                <div class="apple-card canvas-area flex items-center justify-center min-h-[450px] relative overflow-hidden" id="canvasParent">
                    <canvas id="mainCanvas" width="800" height="500" class="max-w-full h-auto cursor-crosshair"></canvas>
                </div>

                <div class="apple-card p-6">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-widest uppercase">历史创作</h3>
                    <div id="historyBar" class="flex gap-4 overflow-x-auto pb-2"></div>
                </div>
            </div>
        </div>

        <footer class="mt-20 py-12 border-t border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex space-x-8 text-sm font-semibold text-gray-400">
                    <a href="#" class="hover:text-black transition">DEVELOPER</a>
                    <a href="#" class="hover:text-black transition">API</a>
                    <a href="#" class="hover:text-black transition">TERMS</a>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-300 tracking-[0.2em] mb-1">DESIGNED BY I DO IT</p>
                    <p class="text-[10px] text-gray-400">© 2024-2026 ALL RIGHTS RESERVED.</p>
                </div>
            </div>
        </footer>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const textInput = document.getElementById('inputText');
        
        let state = {
            text: textInput.value,
            bgColor: '#07C160',
            avatar: null,
            showBadge: false,
            // 初始位置
            textPos: { x: 280, y: 220 },
            avatarPos: { x: 500, y: 170 },
            dragging: null,
            dragOffset: { x: 0, y: 0 }
        };

        // 默认头像
        const defaultAvatar = new Image();
        defaultAvatar.crossOrigin = "anonymous";
        defaultAvatar.src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix'; // 默认占位图
        defaultAvatar.onload = () => { state.avatar = defaultAvatar; updateCanvas(); };

        function changeColor(c) { state.bgColor = c; updateCanvas(); }

        function loadAvatar(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => { state.avatar = img; updateCanvas(); };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function updateCanvas() {
            state.text = textInput.value;
            state.showBadge = document.getElementById('showBadge').checked;
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const lines = state.text.split('\n');
            const fontSize = 32;
            ctx.font = `bold ${fontSize}px 'Noto Sans SC'`;
            
            // 计算多行文案的最宽行
            let maxLineWidth = 0;
            lines.forEach(line => {
                const w = ctx.measureText(line).width;
                if(w > maxLineWidth) maxLineWidth = w;
            });

            // 动态气泡尺寸
            const paddingH = 40;
            const paddingV = 30;
            const bubbleW = maxLineWidth + paddingH * 2;
            const bubbleH = (lines.length * fontSize * 1.2) + paddingV * 1.5;
            
            // 自动关联头像位置在气泡右侧顶部 (如果未被拖动)
            // 这里我们保持自由拖动，所以不强制绑定，但初始化时给个好位置
            
            const bx = state.textPos.x - paddingH;
            const by = state.textPos.y - fontSize - 10;

            // 1. 绘制气泡
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(0,0,0,0.08)';
            ctx.fillStyle = state.bgColor;
            drawRoundedRect(ctx, bx, by, bubbleW, bubbleH, 24);
            
            // 气泡小尾巴
            ctx.beginPath();
            ctx.moveTo(bx + 40, by + bubbleH);
            ctx.lineTo(bx + 30, by + bubbleH + 15);
            ctx.lineTo(bx + 55, by + bubbleH);
            ctx.fill();

            // 2. 绘制多行文字
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#FFFFFF';
            lines.forEach((line, i) => {
                ctx.fillText(line, state.textPos.x, state.textPos.y + (i * fontSize * 1.2));
            });

            // 3. 绘制头像
            if (state.avatar) {
                const size = 100;
                ctx.save();
                ctx.beginPath();
                ctx.arc(state.avatarPos.x + size/2, state.avatarPos.y + size/2, size/2, 0, Math.PI*2);
                ctx.clip();
                ctx.drawImage(state.avatar, state.avatarPos.x, state.avatarPos.y, size, size);
                ctx.restore();

                // 4. 可选装饰项 (I DO Badge)
                if(state.showBadge) {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(state.avatarPos.x + size - 15, state.avatarPos.y + 15, 18, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = 'black';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('IDO', state.avatarPos.x + size - 15, state.avatarPos.y + 19);
                    ctx.textAlign = 'left';
                }
            }
        }

        function drawRoundedRect(ctx, x, y, width, height, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + width - r, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + r);
            ctx.lineTo(x + width, y + height - r);
            ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
            ctx.lineTo(x + r, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.fill();
        }

        // 拖拽逻辑
        canvas.onmousedown = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            // 检查点击了头像还是文案区域
            if (x > state.avatarPos.x && x < state.avatarPos.x + 100 && y > state.avatarPos.y && y < state.avatarPos.y + 100) {
                state.dragging = 'avatar';
                state.dragOffset = { x: x - state.avatarPos.x, y: y - state.avatarPos.y };
            } else {
                state.dragging = 'text';
                state.dragOffset = { x: x - state.textPos.x, y: y - state.textPos.y };
            }
        };

        window.onmousemove = (e) => {
            if (!state.dragging) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            if (state.dragging === 'avatar') {
                state.avatarPos = { x: x - state.dragOffset.x, y: y - state.dragOffset.y };
            } else {
                state.textPos = { x: x - state.dragOffset.x, y: y - state.dragOffset.y };
            }
            draw();
        };

        window.onmouseup = () => { state.dragging = null; };

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'sticker-ido.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // 存入历史
            const historyBar = document.getElementById('historyBar');
            const thumb = document.createElement('img');
            thumb.src = link.href;
            thumb.className = "h-16 rounded-lg border cursor-pointer hover:border-black transition";
            thumb.onclick = () => { /* 可以在此恢复数据 */ };
            historyBar.prepend(thumb);
        }

    </script>
</body>
</html>
