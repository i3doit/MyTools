<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PureDrop Studio | ä¸“ä¸šè¡¨æƒ…åŒ…ç²¾ä¿®</title>
    <style>
        :root { --apple-blue: #0071e3; --apple-bg: #1c1c1e; --apple-gray: #3a3a3c; }
        * { box-sizing: border-box; touch-action: none; -webkit-user-select: none; }
        body { margin: 0; height: 100dvh; background: #000; font-family: -apple-system, sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        
        header { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: rgba(28,28,30,0.95); border-bottom: 1px solid #333; z-index: 100; }
        
        #viewport { flex: 1; position: relative; overflow: hidden; background: #2c2c2e; display: flex; align-items: center; justify-content: center; }
        #canvas-wrapper { position: relative; transform-origin: center; cursor: crosshair; }
        canvas { display: block; background-image: 
            linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%),
            linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 12px 12px; }
        #overlayCanvas { position: absolute; top: 0; left: 0; pointer-events: none; opacity: 0.6; }

        .panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px;
            background: rgba(44, 44, 46, 0.98); backdrop-filter: blur(25px); border-radius: 24px; padding: 16px;
            display: flex; flex-direction: column; gap: 14px; border: 1px solid #48484a; box-shadow: 0 25px 50px rgba(0,0,0,0.6); z-index: 1000; }
        
        .mode-tabs { display: flex; background: #1c1c1e; border-radius: 12px; padding: 3px; gap: 4px; }
        .tab { flex: 1; border: none; background: none; color: #8e8e93; padding: 10px; border-radius: 9px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .tab.active { background: #48484a; color: #fff; }
        .tab.action { background: var(--apple-blue); color: #fff; }

        .controls { display: flex; align-items: center; gap: 12px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 12px; border: none; background: #3a3a3c; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .slider-box { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        input[type="range"] { width: 100%; accent-color: var(--apple-blue); cursor: pointer; }
        .label-row { display: flex; justify-content: space-between; font-size: 10px; color: #8e8e93; }
    </style>
</head>
<body>

<header>
    <div style="color:white; font-weight: 700; font-size: 16px;">PureDrop Studio</div>
    <div style="display: flex; gap: 10px;">
        <button class="tab" style="background:#3a3a3c; color:white; padding: 6px 12px;" onclick="document.getElementById('fileInput').click()">æ‰“å¼€</button>
        <button class="tab action" style="padding: 6px 12px;" onclick="downloadImage()">å¯¼å‡º PNG</button>
    </div>
</header>

<main id="viewport">
    <div id="canvas-wrapper">
        <canvas id="mainCanvas"></canvas>
        <canvas id="overlayCanvas"></canvas>
    </div>
</main>

<div class="panel">
    <div class="mode-tabs">
        <button class="tab active" id="mode-view" onclick="setMode('view')">ğŸ” ç¼©æ”¾å¹³ç§»</button>
        <button class="tab" id="mode-select" onclick="setMode('select')">ğŸ–Œï¸ æ¶‚æŠ¹ä¿ç•™</button>
        <button class="tab" id="mode-erase" onclick="setMode('erase')">ğŸ§½ ç²¾ç»†æ“¦é™¤</button>
    </div>

    <div id="select-bar" style="display: none;">
        <button class="tab action" style="width: 100%;" onclick="confirmSelection()">æå–æ¶‚æŠ¹éƒ¨åˆ† (åˆ é™¤èƒŒæ™¯)</button>
    </div>

    <div class="controls">
        <button class="btn-icon" onclick="undo()" title="æ’¤é”€">â†©ï¸</button>
        <div class="slider-box">
            <div class="label-row"><span>ç¬”è§¦ç²—ç»†</span><span id="brushVal">20px</span></div>
            <input type="range" id="brushSize" min="1" max="100" value="20" oninput="document.getElementById('brushVal').innerText = this.value + 'px'">
        </div>
        <button class="btn-icon" onclick="resetView()" title="å±…ä¸­">ğŸ¯</button>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*">
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const overlay = document.getElementById('overlayCanvas');
    const octx = overlay.getContext('2d');
    const wrapper = document.getElementById('canvas-wrapper');
    const viewport = document.getElementById('viewport');
    const fileInput = document.getElementById('fileInput');

    let mode = 'view';
    let scale = 1, posX = 0, posY = 0;
    let isDrawing = false;
    let undoStack = [];

    // --- 1. ä¿®å¤å›¾ç‰‡åŠ è½½é—®é¢˜ ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const img = new Image();
        img.onload = function() {
            // ç¡®ä¿åŒæ­¥ç”»å¸ƒå°ºå¯¸
            canvas.width = overlay.width = img.width;
            canvas.height = overlay.height = img.height;
            wrapper.style.width = img.width + 'px';
            wrapper.style.height = img.height + 'px';
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            undoStack = []; // é‡ç½®æ’¤é”€æ ˆ
            saveState(); // å­˜å…¥åˆå§‹çŠ¶æ€
            resetView();
            setMode('view');
            fileInput.value = ''; // æ¸…é™¤ input ä»¥ä¾¿ä¸‹æ¬¡èƒ½è§¦å‘åŒä¸€ä¸ªæ–‡ä»¶
        };
        img.src = URL.createObjectURL(file);
    });

    // --- 2. ç¼©æ”¾å¹³ç§»é€»è¾‘ (å…¨å±€ä¿æŒ) ---
    function updateTransform() {
        wrapper.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    function resetView() {
        const v = viewport.getBoundingClientRect();
        scale = Math.min(v.width / canvas.width, v.height / canvas.height) * 0.85;
        posX = 0; posY = 0;
        updateTransform();
    }

    // --- 3. æ¨¡å¼ä¸å…³è”é€»è¾‘ ---
    function setMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('mode-' + newMode).classList.add('active');
        document.getElementById('select-bar').style.display = (mode === 'select') ? 'block' : 'none';
        octx.clearRect(0, 0, overlay.width, overlay.height);
    }

    viewport.onpointerdown = e => {
        isDrawing = true;
        if (mode !== 'view') {
            if (mode === 'erase') saveState(); // æ©¡çš®æ“¦åŠ¨ä½œå‰ä¿å­˜
            draw(e);
        }
    };

    viewport.onpointermove = e => {
        if (!isDrawing) return;
        if (mode === 'view') {
            posX += e.movementX;
            posY += e.movementY;
            updateTransform();
        } else {
            draw(e);
        }
    };

    window.onpointerup = () => {
        isDrawing = false;
        octx.beginPath();
    };

    function draw(e) {
        const rect = canvas.getBoundingClientRect();
        // æ ¸å¿ƒä¿®å¤ï¼šåŸºäºå½“å‰ç¼©æ”¾æ¯”ä¾‹è®¡ç®—ç”»å¸ƒå†…çš„ç²¾ç¡®åƒç´ åæ ‡
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        const brushSize = document.getElementById('brushSize').value;

        if (mode === 'select') {
            octx.fillStyle = '#30d158'; // äº®ç»¿è‰²æç¤º
            octx.beginPath();
            octx.arc(x, y, brushSize/2, 0, Math.PI*2);
            octx.fill();
        } else if (mode === 'erase') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, brushSize/2, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }
    }

    // --- 4. é€‰åŒºå…³è”ï¼šç¡®è®¤æå– ---
    function confirmSelection() {
        saveState(); // è®°å½•æå–å‰çš„åŸå§‹å›¾
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tctx = tempCanvas.getContext('2d');

        tctx.drawImage(canvas, 0, 0); // å­˜åŸå›¾
        tctx.globalCompositeOperation = 'destination-in'; // æ ¸å¿ƒé€»è¾‘ï¼šç›¸äº¤
        tctx.drawImage(overlay, 0, 0); // ç›–ä¸Šç»¿è‰²é®ç½©

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(tempCanvas, 0, 0); // å†™å›
        
        octx.clearRect(0, 0, overlay.width, overlay.height);
        setMode('erase'); // æå–å®Œç«‹å³è¿›å…¥ç²¾ä¿®æ¨¡å¼
    }

    // --- 5. å…³è”æ’¤é”€åŠŸèƒ½ ---
    function saveState() {
        if (undoStack.length >= 20) undoStack.shift();
        undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    }

    function undo() {
        if (undoStack.length < 2) return;
        undoStack.pop(); // å¼¹å‡ºå½“å‰
        const prevData = undoStack[undoStack.length - 1];
        ctx.putImageData(prevData, 0, 0);
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = `PureDrop_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // PC æ»šè½®ç¼©æ”¾æ”¯æŒ
    viewport.onwheel = e => {
        e.preventDefault();
        const factor = e.deltaY > 0 ? 0.9 : 1.1;
        scale *= factor;
        updateTransform();
    };
</script>
</body>
</html>
