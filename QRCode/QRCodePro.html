<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级二维码生成器 - 移动优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #0071e3;
            --bg: #f2f2f7;
            --card-bg: #ffffff;
            --text: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
            --radius: 18px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding-bottom: 40px; }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; }

        /* 顶部 URL 输入区 - 手机端最先显示 */
        .top-input-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: relative;
        }

        .url-group label { display: block; font-weight: 600; margin-bottom: 10px; font-size: 0.95rem; }
        .input-wrapper { position: relative; }
        input[type="url"], input[type="text"] {
            width: 100%; padding: 14px; border: 1.5px solid var(--border); border-radius: 12px;
            font-size: 1rem; outline: none; transition: 0.2s; background: #f9f9f9;
        }
        input:focus { border-color: var(--primary); background: #fff; }
        
        .paste-hint {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: var(--primary); color: white; padding: 6px 12px;
            border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: none;
        }

        /* 布局结构：手机端纵向，PC端双栏 */
        .main-content { display: flex; flex-direction: column; gap: 20px; }

        /* 海报预览区 */
        .preview-container { order: 1; display: flex; justify-content: center; }
        #posterArea {
            width: 320px; padding: 25px; border-radius: 24px; position: relative;
            background: #ffffff; box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .poster-header { display: flex; align-items: center; margin-bottom: 20px; }
        .avatar-wrap { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; overflow: hidden; margin-right: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .user-meta h4 { font-size: 1rem; margin: 0; }
        .user-meta p { font-size: 0.75rem; opacity: 0.8; margin: 0; }

        .qr-box { 
            background: white; padding: 15px; border-radius: 18px; position: relative;
            display: flex; justify-content: center; align-items: center; margin-bottom: 15px;
        }
        .center-logo {
            position: absolute; width: 44px; height: 44px; background: white;
            border-radius: 10px; padding: 3px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; z-index: 5;
        }

        .poster-footer { text-align: center; }
        .expiry-label { font-size: 0.7rem; background: rgba(0,0,0,0.06); padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .promo-txt { font-size: 0.9rem; font-weight: 700; line-height: 1.4; }

        /* 设置区域 - 手机端显示在海报下方 */
        .settings-container { order: 2; display: grid; gap: 15px; }
        .setting-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }

        .option-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .opt-btn {
            padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border);
            font-size: 0.85rem; cursor: pointer; background: #fff; transition: 0.2s;
        }
        .opt-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .color-palette { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; }
        .color-circle { width: 34px; height: 34px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 0 0 1px #ddd; transition: 0.2s; }
        .color-circle.active { transform: scale(1.2); box-shadow: 0 0 0 2px var(--primary); }

        .action-btns { margin-top: 20px; display: grid; gap: 12px; }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-save { background: #34c759; color: white; }
        .btn-refresh { background: var(--primary); color: white; }

        /* PC端布局调整 */
        @media (min-width: 768px) {
            .main-content { flex-direction: row; align-items: flex-start; }
            .preview-container { order: 2; flex: 1; position: sticky; top: 20px; }
            .settings-container { order: 1; flex: 1.2; }
        }

        /* 页脚 */
        footer { margin-top: 40px; text-align: center; font-size: 0.8rem; color: var(--text-sec); border-top: 1px solid var(--border); padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <section class="top-input-section">
        <div class="url-group">
            <label><i class="fas fa-link"></i> 二维码目标网址</label>
            <div class="input-wrapper">
                <input type="url" id="urlInput" placeholder="输入或粘贴 https://..." value="https://i3doit.github.io/MyTools/">
                <div id="pasteHint" class="paste-hint">点击粘贴</div>
            </div>
        </div>
    </section>

    <main class="main-content">
        <section class="preview-container">
            <div id="posterArea">
                <div class="poster-header">
                    <div class="avatar-wrap">
                        <img id="displayAvatar" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVR4nO2Xv0scQRTHP7OCYKWFlZZ2KignInZK0uS0InZp9S8IloII9haC/4KllSBYp9XmHwiChSBYp9XmHwiChSBYp9XmHwiChSCYZ97ubndv9vYm7wcHlt2Z+cx77703uzS7Y69RAnYAnS9vAsX8p0f+mXf/D2Am/70LTAInOfAnAAn8An4BN8AVcAnYAnT+6p9R5T27zG+z0v3uY/y8A9wAm8Am8Bv4BfwCfgG/gH8Z6H73MX7eAW6ATWAT+A38An4B/zLQ/e5j/LwD3ACbwCbwG/gF/AL+ZaD73cf4eQe4ATaBTeA38Av4BfwC/mWh+93H+HkHuAE2gU3gN/AL+AX8An4Bv4B/Weh+9zF+3gFugE1gE/gN/AJ+Ab+Af1nofvcxfq4AdUAnUAd0AnVAJ1AHdAIdv72v+vO7pfrdw/i5AtQBnUAd0AnUAZ1AHdAJdPz2vurP75bqdw/j5wpQB3QCdUAnUAd0AnVAJ1Ax2/vq/78bql+9zB+rgB1QCdQB3QCdUAnUAd0Ah2/va/687ul+t3D+LkC1AGdQB3QCdUAnUAd0Al0/Pa+6s/vlup3D+PnClAHdAJ1QCdQB3QCdUAn0PHb+6o/v1uq3z38A73O9R6vWw6OAAAAAElFTkSuQmCC">
                    </div>
                    <div class="user-meta">
                        <h4 id="viewNick">艾兜兜儿</h4>
                        <p>邀你一起使用</p>
                    </div>
                </div>

                <div class="qr-box">
                    <div id="qrcode"></div>
                    <img id="qrLogo" class="center-logo">
                </div>

                <div class="poster-footer">
                    <div class="expiry-label" id="viewExp">二维码永久有效</div>
                    <div class="promo-txt" id="viewPromo">扫码发现更多精彩工具</div>
                </div>
            </div>
        </section>

        <section class="settings-container">
            <div class="setting-card">
                <label>基本信息</label>
                <input type="text" id="nickInput" value="艾兜兜儿" placeholder="你的昵称" maxlength="10" style="margin-bottom:12px;">
                <input type="text" id="promoInput" value="扫码发现更多精彩工具" placeholder="推广文案">
            </div>

            <div class="setting-card">
                <label>有效期设置</label>
                <div class="option-grid" id="expiryOptions">
                    <div class="opt-btn" data-val="7">7天</div>
                    <div class="opt-btn" data-val="15">15天</div>
                    <div class="opt-btn active" data-val="0">永久</div>
                    <div class="opt-btn" data-val="custom">自定义日期</div>
                </div>
                <input type="date" id="customDate" style="display:none; margin-top:10px;">
            </div>

            <div class="setting-card">
                <label>上传自定义图片</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <div>
                        <span style="font-size:0.7rem; color:var(--text-sec)">更换头像</span>
                        <input type="file" id="upAvatar" accept="image/*" style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                    <div>
                        <span style="font-size:0.7rem; color:var(--text-sec)">中间 Logo</span>
                        <input type="file" id="upLogo" accept="image/*" style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                </div>
            </div>

            <div class="setting-card">
                <label>卡片背景系</label>
                <div class="color-palette" id="colorPalette">
                    </div>
            </div>

            <div class="action-btns">
                <button class="btn btn-refresh" onclick="updatePreview()"><i class="fas fa-sync-alt"></i> 更新预览</button>
                <button class="btn btn-save" onclick="downloadPoster()"><i class="fas fa-file-download"></i> 保存高清图片</button>
            </div>
        </section>
    </main>

    <footer>
        <p>© 2026 艾兜兜儿 | 隐私安全二维码生成工具</p>
    </footer>
</div>

<script>
    // 色系模板配置
    const colorThemes = [
        { bg: '#ffffff', text: '#333', name: '经典白' },
        { bg: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', text: '#1d1d1f', name: '极简灰' },
        { bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', text: '#fff', name: '幻影紫' },
        { bg: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', text: '#d63384', name: '甜心粉' },
        { bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', text: '#006d77', name: '青草绿' },
        { bg: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', text: '#b02a37', name: '暖阳橙' },
        { bg: 'linear-gradient(135deg, #121212 0%, #434343 100%)', text: '#ffd700', name: '暗夜金' }
    ];

    // 初始化背景选择器
    const palette = document.getElementById('colorPalette');
    colorThemes.forEach((th, idx) => {
        const dot = document.createElement('div');
        dot.className = `color-circle ${idx === 0 ? 'active' : ''}`;
        dot.style.background = th.bg;
        dot.onclick = () => {
            document.querySelectorAll('.color-circle').forEach(d => d.classList.remove('active'));
            dot.classList.add('active');
            const area = document.getElementById('posterArea');
            area.style.background = th.bg;
            area.style.color = th.text;
        };
        palette.appendChild(dot);
    });

    // 剪贴板功能
    const urlIn = document.getElementById('urlInput');
    const pasteH = document.getElementById('pasteHint');
    urlIn.onfocus = () => pasteH.style.display = 'block';
    document.addEventListener('mousedown', (e) => { if (e.target !== urlIn && e.target !== pasteH) pasteH.style.display = 'none'; });
    pasteH.onclick = async () => {
        try { const t = await navigator.clipboard.readText(); if(t) urlIn.value = t; updatePreview(); } catch(e){}
        pasteH.style.display = 'none';
    };

    // 有效期逻辑
    const expiryBtns = document.querySelectorAll('#expiryOptions .opt-btn');
    const datePicker = document.getElementById('customDate');
    expiryBtns.forEach(btn => {
        btn.onclick = () => {
            expiryBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            datePicker.style.display = btn.dataset.val === 'custom' ? 'block' : 'none';
            updatePreview();
        };
    });

    // 二维码初始化 (手机端缩小尺寸)
    const isMobile = window.innerWidth < 768;
    const qrcode = new QRCode(document.getElementById("qrcode"), {
        width: isMobile ? 180 : 200,
        height: isMobile ? 180 : 200,
        correctLevel: QRCode.CorrectLevel.H
    });

    // 文件处理
    function setupFile(inputId, imgId, isLogo = false) {
        document.getElementById(inputId).onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById(imgId);
                    img.src = ev.target.result;
                    if(isLogo) img.style.display = 'block';
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        };
    }
    setupFile('upAvatar', 'displayAvatar');
    setupFile('upLogo', 'qrLogo', true);

    // 核心更新函数
    function updatePreview() {
        const url = urlIn.value.trim() || "https://i3doit.github.io/MyTools/";
        document.getElementById('viewNick').innerText = document.getElementById('nickInput').value;
        document.getElementById('viewPromo').innerText = document.getElementById('promoInput').value;

        // 计算日期
        const activeBtn = document.querySelector('#expiryOptions .active');
        const val = activeBtn.dataset.val;
        const expEl = document.getElementById('viewExp');

        if (val === '0') {
            expEl.innerText = "二维码永久有效";
        } else {
            let targetDate;
            if (val === 'custom') {
                targetDate = new Date(datePicker.value);
            } else {
                targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + parseInt(val));
            }
            
            if (isNaN(targetDate.getTime())) {
                expEl.innerText = "请选择日期";
            } else {
                const today = new Date();
                today.setHours(0,0,0,0);
                const diff = Math.ceil((targetDate - today) / 86400000);
                expEl.innerText = `有效期至: ${targetDate.toLocaleDateString()} (剩 ${diff} 天)`;
            }
        }
        qrcode.makeCode(url);
    }

    // 保存图片
    async function downloadPoster() {
        updatePreview();
        const btn = document.querySelector('.btn-save');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成...';
        
        try {
            const canvas = await html2canvas(document.getElementById('posterArea'), {
                scale: window.devicePixelRatio * 1.5,
                useCORS: true,
                backgroundColor: null
            });
            const link = document.createElement('a');
            link.download = `QRPoster_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch (e) {
            alert('保存失败，请截图保存');
        } finally {
            btn.innerHTML = '<i class="fas fa-file-download"></i> 保存高清图片';
        }
    }

    // 初始生成
    window.onload = updatePreview;
</script>

</body>
</html>
