<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dæ˜Ÿç©ºèºæ—‹åœ£è¯æ ‘ - èŠ‚æ—¥è´ºå¡</title>
    <style>
        :root {
            --gold: #ffd700;
            --light-gold: #fff3b0;
            --red: #ff4d4d;
            --green: #2ecc71;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at center, #0a192f 0%, #000 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* èƒŒæ™¯é›ªèŠ±ç”»å¸ƒ */
        #snowCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* 3D åœºæ™¯å®¹å™¨ */
        .world {
            position: relative;
            width: 100%;
            height: 70vh;
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .tree-system {
            position: relative;
            width: 0;
            height: 0;
            transform-style: preserve-3d;
            animation: rotateTree 15s linear infinite;
        }

        @keyframes rotateTree {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        /* é¡¶éƒ¨é—ªäº®æ˜Ÿæ˜Ÿ */
        .top-star {
            position: absolute;
            top: -220px; /* ä½äºæ ‘å°– */
            left: -25px;
            width: 50px;
            height: 50px;
            background: var(--gold);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            box-shadow: 0 0 50px var(--gold);
            transform-style: preserve-3d;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.3); }
        }

        /* èºæ—‹ç‚¹å’Œè£…é¥° */
        .dot {
            position: absolute;
            border-radius: 50%;
            transform-style: preserve-3d;
        }

        .ornament {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }

        /* ç¯ç»•æ–‡æ¡ˆ */
        .wish-char {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: var(--light-gold);
            text-shadow: 0 0 10px var(--gold);
            white-space: nowrap;
            pointer-events: none;
        }

        /* ç¤¼ç‰©ç›’åŒºåŸŸ */
        .gifts-container {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            z-index: 3;
            perspective: 1000px;
        }

        .gift {
            position: relative;
            width: 60px;
            height: 50px;
            cursor: pointer;
            transition: transform 0.3s;
            transform-style: preserve-3d;
        }

        .gift:hover {
            transform: translateY(-10px) rotateY(20deg);
        }

        .gift-box {
            width: 100%;
            height: 100%;
            background: var(--red);
            border: 2px solid #900;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .gift-ribbon {
            position: absolute;
            width: 10px;
            height: 100%;
            background: var(--gold);
        }
        .gift-ribbon-h {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }
        .gift-ribbon-h::after {
            content: '';
            width: 100%;
            height: 10px;
            background: var(--gold);
        }

        /* å¼¹çª—æ ·å¼ */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 320px;
            box-shadow: 0 0 30px var(--gold);
        }

        .modal input {
            width: 90%;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        /* éŸ³ä¹æ§åˆ¶ */
        .audio-ctrl {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
        }

        .share-url {
            font-size: 10px;
            word-break: break-all;
            margin-top: 15px;
            color: #666;
            background: #f0f0f0;
            padding: 5px;
        }
    </style>
</head>
<body>

<!-- èƒŒæ™¯éŸ³ä¹ (Jingle Bells) -->
<div class="audio-ctrl" onclick="toggleMusic()" id="musicBtn">ğŸµ</div>
<audio id="bgMusic" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    <!-- æ³¨æ„ï¼šç”±äºç‰ˆæƒåŸå› ï¼Œè¿™é‡Œä½¿ç”¨äº†ç¤ºä¾‹éŸ³ä¹ï¼Œä½ å¯ä»¥æ¢æˆä»»æ„ Jingle Bells çš„ MP3 é“¾æ¥ -->
</audio>

<canvas id="snowCanvas"></canvas>

<div class="world">
    <div class="tree-system" id="treeSystem">
        <!-- é¡¶éƒ¨æ˜Ÿæ˜Ÿ -->
        <div class="top-star"></div>
        <!-- æ ‘èº«å’Œè£…é¥°å°†ç”± JS ç”Ÿæˆ -->
        <div id="wishOrbit" style="transform-style: preserve-3d;"></div>
    </div>
</div>

<div class="gifts-container">
    <div class="gift" style="transform: scale(0.9);" onclick="showModal()">
        <div class="gift-box" style="background: #e74c3c;">
            <div class="gift-ribbon"></div>
            <div class="gift-ribbon-h"></div>
        </div>
    </div>
    <div class="gift" style="transform: scale(1.2);" onclick="showModal()">
        <div class="gift-box" style="background: #3498db;">
            <div class="gift-ribbon"></div>
            <div class="gift-ribbon-h"></div>
        </div>
    </div>
    <div class="gift" onclick="showModal()">
        <div class="gift-box" style="background: #f1c40f;">
            <div class="gift-ribbon"></div>
            <div class="gift-ribbon-h"></div>
        </div>
    </div>
</div>

<!-- å¼¹çª— -->
<div class="overlay" id="overlay">
    <div class="modal">
        <h2>å¯„é€åœ£è¯ç¥ç¦</h2>
        <p>è¾“å…¥ä½ çš„æ„¿æœ›ï¼Œç”Ÿæˆä¸“å±é“¾æ¥åˆ†äº«ç»™å¥½å‹</p>
        <input type="text" id="wishInput" placeholder="ä¾‹å¦‚ï¼šç¥ä½ åœ£è¯å¿«ä¹ï¼Œå¿ƒæƒ³äº‹æˆï¼" maxlength="30">
        <button class="btn" onclick="generateLink()">ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
        <div id="linkOutput" class="share-url" style="display:none;"></div>
        <button class="btn" style="background:#999; margin-top:10px;" onclick="hideModal()">å…³é—­</button>
    </div>
</div>

<script>
    const treeSystem = document.getElementById('treeSystem');
    const wishOrbit = document.getElementById('wishOrbit');
    const snowCanvas = document.getElementById('snowCanvas');
    const ctx = snowCanvas.getContext('2d');

    // 1. åˆå§‹åŒ–é›ªèŠ±èƒŒæ™¯
    let width, height, snowflakes = [];
    function initSnow() {
        width = snowCanvas.width = window.innerWidth;
        height = snowCanvas.height = window.innerHeight;
        snowflakes = Array.from({length: 150}, () => ({
            x: Math.random() * width,
            y: Math.random() * height,
            r: Math.random() * 3 + 1,
            v: Math.random() * 2 + 0.5
        }));
    }
    function drawSnow() {
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = "white";
        snowflakes.forEach(s => {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
            s.y += s.v;
            if (s.y > height) s.y = -10;
        });
        requestAnimationFrame(drawSnow);
    }
    window.addEventListener('resize', initSnow);
    initSnow();
    drawSnow();

    // 2. ç”Ÿæˆèºæ—‹åœ£è¯æ ‘
    function createTree() {
        const dots = 240;
        for (let i = 0; i < dots; i++) {
            const angle = i * 0.2;
            const y = i * 0.8 - 200; // ä»æ˜Ÿæ˜Ÿä¸‹æ–¹å¼€å§‹å¾€ä¸‹å»¶ä¼¸
            const radius = i * 0.5;
            
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;

            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.width = (Math.random() * 3 + 2) + 'px';
            dot.style.height = dot.style.width;
            dot.style.background = i % 5 === 0 ? 'var(--gold)' : 'var(--green)';
            dot.style.boxShadow = `0 0 8px ${dot.style.background}`;
            dot.style.transform = `translate3d(${x}px, ${y}px, ${z}px)`;
            treeSystem.appendChild(dot);

            // éšæœºå¢åŠ ä¸€äº›å½©ç¯è£…é¥°
            if (i % 12 === 0) {
                const ornament = document.createElement('div');
                ornament.className = 'ornament';
                const colors = ['#ff4d4d', '#ffffff', '#ffd700', '#3498db'];
                ornament.style.background = colors[Math.floor(Math.random() * colors.length)];
                ornament.style.transform = `translate3d(${x*1.1}px, ${y}px, ${z*1.1}px)`;
                treeSystem.appendChild(ornament);
            }
        }
    }
    createTree();

    // 3. å¤„ç†åˆ†äº«é€»è¾‘å’ŒåŠ¨æ€æ–‡æ¡ˆ
    function getQueryParam() {
        const params = new URLSearchParams(window.location.search);
        return params.get('msg');
    }

    function displayWish(text) {
        wishOrbit.innerHTML = '';
        const chars = text.split('');
        const radius = 180;
        chars.forEach((char, i) => {
            const el = document.createElement('div');
            el.className = 'wish-char';
            el.innerText = char;
            const angle = (i / chars.length) * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = (i % 3) * 20 - 50; // ç¨å¾®é”™ä½æ›´æœ‰åŠ¨æ„Ÿ
            el.style.transform = `translate3d(${x}px, ${y}px, ${z}px) rotateY(${-angle}rad)`;
            wishOrbit.appendChild(el);
        });
    }

    const savedMsg = getQueryParam();
    if (savedMsg) {
        displayWish(decodeURIComponent(savedMsg));
    }

    // 4. äº¤äº’åŠŸèƒ½
    function showModal() {
        document.getElementById('overlay').style.display = 'flex';
    }
    function hideModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('linkOutput').style.display = 'none';
    }

    function generateLink() {
        const val = document.getElementById('wishInput').value;
        if (!val) return alert('è¯·è¾“å…¥ç¥ç¦è¯­');
        
        const url = window.location.origin + window.location.pathname + '?msg=' + encodeURIComponent(val);
        const output = document.getElementById('linkOutput');
        output.innerText = url;
        output.style.display = 'block';
        
        displayWish(val); // å®æ—¶é¢„è§ˆ

        navigator.clipboard.writeText(url).then(() => {
            alert('åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼å‘ç»™ä½ çš„æœ‹å‹çœ‹çœ‹å§ã€‚');
        });
    }

    // 5. éŸ³ä¹æ§åˆ¶
    function toggleMusic() {
        const audio = document.getElementById('bgMusic');
        const btn = document.getElementById('musicBtn');
        if (audio.paused) {
            audio.play();
            btn.innerText = 'â¸';
            btn.style.animation = 'rotateTree 2s linear infinite';
        } else {
            audio.pause();
            btn.innerText = 'ğŸµ';
            btn.style.animation = 'none';
        }
    }
</script>

</body>
</html>