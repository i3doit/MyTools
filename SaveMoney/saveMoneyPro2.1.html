<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†·é™è´­ - ä½ çš„æ™ºèƒ½æ¶ˆè´¹å®ˆå«</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://fav.farm/ğŸ›¡ï¸">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --apple-blue: #0071e3; --apple-red: #ff3b30; --apple-green: #34c759;
            --apple-card: rgba(255, 255, 255, 0.8); --glass-blur: 20px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { min-height: 100vh; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); background-attachment: fixed; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* å®¹å™¨æ ·å¼ */
        .card-box { width: 100%; max-width: 500px; background: var(--apple-card); backdrop-filter: blur(var(--glass-blur)); border-radius: 24px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        h1 { font-size: 22px; text-align: center; margin-bottom: 20px; }
        .form-group { position: relative; margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #6e6e73; margin-bottom: 5px; margin-left: 5px; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; background: rgba(255,255,255,0.5); font-size: 16px; outline: none; }
        .clear-btn { position: absolute; right: 10px; top: 30px; color: #ccc; display: none; font-size: 20px; cursor: pointer; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 14px; font-size: 16px; font-weight: 500; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: var(--apple-blue); color: white; }
        .btn-ghost { background: rgba(255,255,255,0.3); border: 1px solid rgba(0,0,0,0.1); color: #1d1d1f; }
        
        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .item-card { background: white; border-radius: 18px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--apple-blue); animation: slideIn 0.3s ease; }
        .tag { font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 10px; margin-bottom: 8px; display: inline-block; }
        .tag-wait { background: #fff2cc; color: #d4a017; }
        .tag-done { background: #d1e7dd; color: #0f5132; }

        /* å¼¹çª— */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 24px; width: 100%; max-width: 400px; padding: 20px; text-align: center; }
        #canvasContainer { width: 100%; margin-bottom: 15px; border-radius: 12px; overflow: hidden; border: 1px solid #eee; }
        canvas { width: 100%; height: auto; display: block; }

        /* å†å²è®°å½• */
        .history-box { text-align: left; max-height: 150px; overflow-y: auto; margin: 15px 0; font-size: 12px; border-top: 1px solid #eee; padding-top: 10px; }
        .history-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #f0f0f0; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="toast" style="position:fixed; top:30px; background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:10000; display:none; font-size:14px;"></div>

    <div class="card-box">
        <h1>å†·é™è´­ ğŸ›¡ï¸</h1>
        <div class="form-group">
            <label>å•†å“åç§° (é™20å­—)</label>
            <input type="text" id="itemName" maxlength="20" oninput="toggleClear(this)">
            <span class="clear-btn" onclick="clearInp('itemName')">Ã—</span>
        </div>
        <div class="form-group">
            <label>ä»·æ ¼ (0.01 - 999,999)</label>
            <input type="number" id="itemPrice" step="0.01" oninput="toggleClear(this)">
            <span class="clear-btn" onclick="clearInp('itemPrice')">Ã—</span>
        </div>
        <div class="form-group">
            <label>å†·é™ç†ç”±</label>
            <textarea id="itemReason" rows="2" maxlength="50" oninput="toggleClear(this)"></textarea>
            <span class="clear-btn" style="top:30px" onclick="clearInp('itemReason')">Ã—</span>
        </div>
        <button class="btn btn-primary" onclick="addItem()">å­˜å…¥å†·é™æœŸ (48h)</button>
    </div>

    <div id="list" style="width:100%; max-width:500px;"></div>

    <button class="btn btn-ghost" style="max-width:500px;" onclick="openModal()">ç”Ÿæˆæˆ˜æŠ¥ & å†å²è®°å½• ğŸ“Š</button>

    <div id="modal">
        <div class="modal-content">
            <div id="canvasContainer">
                <canvas id="shareCanvas"></canvas>
            </div>
            <p style="font-size: 11px; color: #999; margin-bottom: 10px;">é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡æˆ–ç‚¹å‡»ä¸‹è½½ä¿å­˜</p>
            
            <div class="history-box" id="historyList"></div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="margin:0; background:var(--apple-green)" onclick="downloadImg()">ä¿å­˜ç›¸å†Œ</button>
                <button class="btn btn-ghost" style="margin:0" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let storage = JSON.parse(localStorage.getItem('cg_items')) || [];
        let history = JSON.parse(localStorage.getItem('cg_history')) || [];
        let totalSaved = parseFloat(localStorage.getItem('cg_total')) || 0;

        // 1. åŸºç¡€åŠŸèƒ½
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
        function toggleClear(el) { el.nextElementSibling.style.display = el.value ? 'block' : 'none'; }
        function clearInp(id) { const el=document.getElementById(id); el.value=''; toggleClear(el); }

        // 2. ä»·æ ¼è¾¹ç•Œä¸éªŒè¯
        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const priceInp = document.getElementById('itemPrice').value;
            const price = parseFloat(priceInp);
            const reason = document.getElementById('itemReason').value.trim();

            if(!name) return showToast("è¯·è¾“å…¥å•†å“å");
            if(isNaN(price) || price < 0.01 || price > 999999) return showToast("ä»·æ ¼éœ€åœ¨ 0.01 - 999,999 ä¹‹é—´");

            const item = { id: Date.now(), name, price, reason, createAt: Date.now(), notified: false };
            storage.unshift(item);
            save();
            render();
            ['itemName','itemPrice','itemReason'].forEach(id => clearInp(id));
            showToast("å·²å¼€å¯å†·é™æœŸ ğŸ”’");
            if (Notification.permission !== 'granted') Notification.requestPermission();
        }

        // 3. åŠ¨æ€åˆ—è¡¨æ¸²æŸ“
        function render() {
            const container = document.getElementById('list');
            container.innerHTML = '';
            const now = Date.now();

            storage.forEach(item => {
                const remains = (item.createAt + 48*3600000) - now;
                const isReady = remains <= 0;
                
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <span class="tag ${isReady ? 'tag-done':'tag-wait'}">${isReady ? 'âœ… å†·é™æœŸç»“æŸ' : 'â³ '+formatTime(remains)}</span>
                    <h3 style="font-size:16px;">${item.name}</h3>
                    <p style="color:var(--apple-blue); font-weight:600; font-size:18px;">ï¿¥${item.price.toLocaleString()}</p>
                    <p style="font-size:12px; color:#86868b; margin-top:5px;">ç†ç”±ï¼š${item.reason || 'æ— '}</p>
                    <div style="display:flex; gap:10px; margin-top:12px;">
                        <button class="btn btn-primary" style="margin:0; flex:1; background:var(--apple-red)" onclick="removeItem(${item.id}, true)">çœä¸‹äº†</button>
                        ${isReady ? `<button class="btn btn-primary" style="margin:0; flex:1; background:var(--apple-green)" onclick="removeItem(${item.id}, false)">ä¹°äº†</button>`:''}
                    </div>
                `;
                container.appendChild(div);

                // æ¨é€æ£€æŸ¥
                if(isReady && !item.notified) {
                    new Notification("å†·é™è´­æç¤º", { body: `[${item.name}] å†·é™æœŸå·²ç»“æŸï¼Œå»çœ‹çœ‹è¿˜æƒ³ä¹°å—ï¼Ÿ`, icon: "https://fav.farm/ğŸ›¡ï¸" });
                    item.notified = true;
                }
            });
        }

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${h}æ—¶${m}åˆ†${s}ç§’`;
        }

        function removeItem(id, saved) {
            const idx = storage.findIndex(i => i.id === id);
            if(saved) {
                totalSaved += storage[idx].price;
                history.unshift({ name: storage[idx].name, price: storage[idx].price, date: new Date().toLocaleDateString() });
                localStorage.setItem('cg_total', totalSaved);
                localStorage.setItem('cg_history', JSON.stringify(history.slice(0, 20)));
            }
            storage.splice(idx, 1);
            save();
            render();
            showToast(saved ? "æˆå°±è¾¾æˆï¼çœä¸‹ä¸€ç¬” ğŸ’°" : "æ¶ˆè´¹è®°å½•å·²æ›´æ–°");
        }

        function save() { localStorage.setItem('cg_items', JSON.stringify(storage)); }

        // 4. åˆ†äº«å¡ç‰‡ç»˜åˆ¶ (ä¼˜åŒ–é‡‘é¢æº¢å‡º)
        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            renderHistory();
            drawCanvas();
        }

        function renderHistory() {
            const hList = document.getElementById('historyList');
            hList.innerHTML = '<strong>çœé’±å†å² (æœ€è¿‘20æ¡):</strong>';
            if(history.length === 0) hList.innerHTML += '<p style="color:#ccc">æš‚æ— æ•°æ®</p>';
            history.forEach(h => {
                hList.innerHTML += `<div class="history-item"><span>${h.date} ${h.name}</span> <span style="color:var(--apple-green)">+ï¿¥${h.price.toLocaleString()}</span></div>`;
            });
        }

        function drawCanvas() {
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 800;

            // èƒŒæ™¯
            ctx.fillStyle = '#8ec5fc'; ctx.fillRect(0,0,600,800);
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.roundRect(30,30,540,740,40); ctx.fill();

            // æ ‡é¢˜
            ctx.fillStyle = '#1d1d1f'; ctx.font = 'bold 36px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('å†·é™è´­ Â· çœé’±æˆå°±', 300, 100);

            // é‡‘é¢ (åŠ¨æ€ç¼©æ”¾é˜²æ­¢æº¢å‡º)
            const displayAmt = 'ï¿¥' + totalSaved.toLocaleString();
            let fontSize = 90;
            if(displayAmt.length > 8) fontSize = 60;
            if(displayAmt.length > 12) fontSize = 40;
            
            ctx.fillStyle = '#34c759'; ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.fillText(displayAmt, 300, 300);
            
            ctx.fillStyle = '#86868b'; ctx.font = '24px sans-serif';
            ctx.fillText('æˆ‘å·²æˆåŠŸèŠ‚çœ', 300, 200);
            ctx.fillText('ç†æ™ºï¼Œæ˜¯é€šå¾€è´¢åŠ¡è‡ªç”±çš„é˜¶æ¢¯', 300, 400);

            // å¼•æµåŒºåŸŸ
            ctx.fillStyle = '#f5f5f7'; ctx.fillRect(30, 600, 540, 170);
            ctx.fillStyle = '#1d1d1f'; ctx.textAlign = 'left'; ctx.font = 'bold 22px sans-serif';
            ctx.fillText('æŠ€æœ¯æ”¯æŒï¼šè‰¾å…œå…œå„¿', 60, 660);
            ctx.font = '18px sans-serif'; ctx.fillText('æ‰«ç å¼€å¯ä½ çš„å†·é™æ¶ˆè´¹ä¹‹æ—…', 60, 700);
            ctx.fillStyle = '#34c759'; ctx.font = 'bold 20px sans-serif'; ctx.fillText('â€œæ‰«ç ä¸€èµ·çœçœçœâ€', 60, 740);

            // äºŒç»´ç  (æ¨¡æ‹Ÿ)
            const qrSize = 120;
            const qrImg = new Image();
            qrImg.crossOrigin = "anonymous";
            qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(window.location.href);
            qrImg.onload = () => ctx.drawImage(qrImg, 420, 625, qrSize, qrSize);
        }

        // 5. å›¾ç‰‡ä¸‹è½½å…¼å®¹æ€§ä¿®å¤
        function downloadImg() {
            const canvas = document.getElementById('shareCanvas');
            try {
                // å°† canvas è½¬ä¸º Blob
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å†·é™è´­æˆå°±-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("ä¸‹è½½æŒ‡ä»¤å·²å‘é€ï¼Œè¯·æŸ¥çœ‹");
                }, 'image/png');
            } catch (e) {
                // å¦‚æœæ˜¯ç§»åŠ¨ç«¯æµè§ˆå™¨é™åˆ¶ç‚¹å‡»ï¼Œå¼•å¯¼ç”¨æˆ·é•¿æŒ‰
                showToast("è¯·é•¿æŒ‰å›¾ç‰‡æ‰‹åŠ¨ä¿å­˜");
            }
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        setInterval(render, 1000);
        render();
    </script>
</body>
</html>
