<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>消灭星星 - 优化版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a2026 0%, #12181d 100%);
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            color: #e6f1ff;
        }

        /* 毛玻璃顶部栏 */
        .top-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(26, 32, 44, 0.55);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(92, 107, 128, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            flex-wrap: wrap;
            gap: 12px;
        }

        .info-block {
            text-align: center;
            min-width: 90px;
        }

        .info-title {
            font-size: 14px;
            font-weight: 500;
            color: #a0aec0;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 22px;
            font-weight: 700;
            color: #e6f1ff;
        }

        .target-score {
            color: #63b3ed;
        }

        .current-score {
            color: #68d391;
        }

        .highest-score {
            color: #f6e05e;
        }

        /* 游戏主区域 */
        .game-board-container {
            position: relative;
            background: rgba(26, 32, 44, 0.35);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid rgba(92, 107, 128, 0.3);
            overflow: hidden;
            aspect-ratio: 1 / 1;
        }

        .game-canvas {
            background-color: rgba(11, 15, 18, 0.7);
            border-radius: 12px;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* 控制面板 */
        .control-panel {
            padding: 15px;
            background: rgba(26, 32, 44, 0.55);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(92, 107, 128, 0.5);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 16px;
            background: rgba(45, 55, 72, 0.7);
            border: 1px solid rgba(92, 107, 128, 0.5);
            color: #e6f1ff;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 16px;
        }

        .btn:hover {
            background: rgba(66, 153, 225, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .btn-primary {
            background: rgba(56, 178, 172, 0.5);
            border-color: rgba(56, 178, 172, 0.4);
        }

        .btn-danger {
            background: rgba(245, 101, 101, 0.5);
            border-color: rgba(245, 101, 101, 0.4);
        }

        .settings-group {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(92, 107, 128, 0.3);
        }

        .setting-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            min-width: 150px;
        }

        .setting-label {
            flex: 1;
            font-size: 15px;
            color: #cbd5e0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(92, 107, 128, 0.5);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: rgba(56, 178, 172, 0.7);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* 反馈消息 */
        .feedback-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.8rem;
            font-weight: 900;
            color: #f6e05e;
            text-shadow: 0 0 10px rgba(246, 224, 94, 0.8);
            text-align: center;
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.5s;
        }

        .feedback-visible {
            opacity: 1;
            transform: translate(-50%, -70%);
        }

        .special-effects {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f6e05e;
            opacity: 0.8;
        }
        
        /* 移动端优化 */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .top-info-bar {
                padding: 10px;
                gap: 8px;
            }
            
            .info-block {
                min-width: 70px;
            }
            
            .info-title {
                font-size: 12px;
            }
            
            .info-value {
                font-size: 18px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 80px;
            }
            
            .toggle-switch {
                width: 40px;
                height: 20px;
            }
            
            .toggle-slider:before {
                height: 14px;
                width: 14px;
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(20px);
            }
            
            .control-panel {
                padding: 12px;
            }
            
            .feedback-message {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                min-width: 70px;
                font-size: 13px;
                padding: 7px 10px;
            }
            
            .button-group {
                gap: 8px;
            }
            
            .setting-item {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 顶部状态栏 -->
        <div class="top-info-bar">
            <div class="info-block">
                <div class="info-title">当前关卡</div>
                <div id="current-level" class="info-value">1</div>
            </div>
            <div class="info-block">
                <div class="info-title">目标分数</div>
                <div id="target-score" class="info-value target-score">0</div>
            </div>
            <div class="info-block">
                <div class="info-title">当前分数</div>
                <div id="current-score" class="info-value current-score">0</div>
            </div>
            <div class="info-block">
                <div class="info-title">最高分</div>
                <div id="highest-score" class="info-value highest-score">0</div>
            </div>
        </div>

        <!-- 游戏棋盘区域 -->
        <div class="game-board-container">
            <canvas id="game-board" class="game-canvas"></canvas>
            <div id="feedback-message" class="feedback-message"></div>
            <div id="special-effects" class="special-effects"></div>
        </div>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="button-group">
                <button id="reset-btn" class="btn btn-danger">
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                    </svg>
                    重置
                </button>
                <button id="refresh-btn" class="btn btn-primary">
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                    </svg>
                    刷新
                </button>
            </div>
            
            <div class="button-group">
                <button id="settings-btn" class="btn">
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    设置
                </button>
                <button id="leaderboard-btn" class="btn">
                    <svg class="btn-icon" viewBox="0 0 24 24">
                        <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M9 17H7V10H9V17M13 17H11V7H13V17M17 17H15V13H17V17Z"/>
                    </svg>
                    排行榜
                </button>
            </div>
            
            <div class="settings-group">
                <h3 style="text-align: center; margin-bottom: 10px;">游戏设置</h3>
                <div class="setting-row">
                    <div class="setting-item">
                        <div class="setting-label">音效</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">动画效果</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">主题模式</div>
                        <select id="theme-select" class="btn" style="width:120px; padding: 5px 8px;">
                            <option value="auto">自动</option>
                            <option value="light">浅色</option>
                            <option value="dark">深色</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏核心类
        class StarEliminationGame {
            constructor() {
                // 游戏状态变量
                this.currentLevel = 1;
                this.currentScore = 0;
                this.targetScore = 0;
                this.highestScore = 0;
                
                // 游戏设置
                this.soundEnabled = true;
                this.animationEnabled = true;
                this.theme = 'auto';
                
                // 棋盘相关
                this.boardSize = 10;
                this.board = [];
                this.starColors = ['#FF5252', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0'];
                
                // DOM元素
                this.canvas = document.getElementById('game-board');
                this.ctx = this.canvas.getContext('2d');
                this.feedbackElement = document.getElementById('feedback-message');
                this.specialEffectsElement = document.getElementById('special-effects');
                
                // 初始化
                this.init();
            }
            
            init() {
                // 加载已保存的状态
                this.loadGameState();
                
                // 设置画布尺寸
                this.resizeCanvas();
                
                // 事件监听器
                this.setupEventListeners();
                
                // 生成棋盘
                this.generateBoard();
                
                // 计算目标分数
                this.calculateTargetScore();
                
                // 更新UI
                this.updateUI();
                
                // 初始绘制
                this.drawBoard();
            }
            
            resizeCanvas() {
                // 计算棋盘尺寸 - 确保1:1正方形
                const container = document.querySelector('.game-board-container');
                const size = Math.min(container.clientWidth, container.clientHeight);
                
                // 设置画布尺寸
                this.canvas.width = size;
                this.canvas.height = size;
                
                // 计算单元大小
                this.cellSize = size / this.boardSize;
            }
            
            generateBoard() {
                this.board = [];
                for (let i = 0; i < this.boardSize; i++) {
                    this.board[i] = [];
                    for (let j = 0; j < this.boardSize; j++) {
                        // 随机颜色
                        this.board[i][j] = Math.floor(Math.random() * this.starColors.length);
                    }
                }
            }
            
            calculateTargetScore() {
                this.targetScore = 500 + this.currentLevel * 100 + Math.floor(100 * Math.pow(1.4, this.currentLevel - 1));
            }
            
            drawBoard() {
                // 清空画布
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制棋盘背景
                this.ctx.fillStyle = 'rgba(11, 15, 18, 0.7)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制网格线
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                
                // 画垂直线
                for (let i = 0; i <= this.boardSize; i++) {
                    const x = i * this.cellSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                // 画水平线
                for (let i = 0; i <= this.boardSize; i++) {
                    const y = i * this.cellSize;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // 绘制所有星星
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        if (this.board[i][j] !== null) {
                            const colorIndex = this.board[i][j];
                            const color = this.starColors[colorIndex];
                            
                            // 计算星星位置
                            const x = j * this.cellSize + this.cellSize / 2;
                            const y = i * this.cellSize + this.cellSize / 2;
                            const radius = this.cellSize * 0.38;
                            
                            // 绘制星星
                            this.drawStar(x, y, radius, color);
                        }
                    }
                }
            }
            
            drawStar(x, y, radius, color) {
                this.ctx.save();
                this.ctx.beginPath();
                
                // 创建径向渐变实现立体效果
                const gradient = this.ctx.createRadialGradient(
                    x, y, 0,
                    x, y, radius
                );
                gradient.addColorStop(0, lightenColor(color, 40));
                gradient.addColorStop(1, color);
                
                this.ctx.fillStyle = gradient;
                
                // 绘制简单的圆形星星
                this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                this.ctx.fill();
                
                // 添加高光效果
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.arc(x - radius * 0.2, y - radius * 0.2, radius * 0.3, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.restore();
            }
            
            onCanvasClick(e) {
                // 立即响应点击，提高交互感
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // 计算点击位置对应的行和列
                const col = Math.floor(x / this.cellSize);
                const row = Math.floor(y / this.cellSize);
                
                // 检查点击是否在棋盘内
                if (row >= 0 && row < this.boardSize && col >= 0 && col < this.boardSize && this.board[row][col] !== null) {
                    this.removeStarGroup(row, col);
                }
            }
            
            removeStarGroup(row, col) {
                const color = this.board[row][col];
                if (color === null) return;
                
                // 使用队列实现BFS查找相邻同色星星
                const group = [];
                const queue = [[row, col]];
                const visited = new Set();
                
                while (queue.length > 0) {
                    const [r, c] = queue.shift();
                    const key = `${r},${c}`;
                    
                    // 跳过已访问或无效位置
                    if (visited.has(key)) continue;
                    visited.add(key);
                    
                    // 检查是否是同色星星
                    if (r < 0 || r >= this.boardSize || c < 0 || c >= this.boardSize || 
                        this.board[r][c] !== color || this.board[r][c] === null) {
                        continue;
                    }
                    
                    // 添加到组中
                    group.push({row: r, col: c});
                    
                    // 添加相邻位置
                    queue.push([r - 1, c]); // 上
                    queue.push([r + 1, c]); // 下
                    queue.push([r, c - 1]); // 左
                    queue.push([r, c + 1]); // 右
                }
                
                // 如果找到的星星组只有一个，则不消除
                if (group.length < 2) return;
                
                // 计算得分
                const points = this.calculatePoints(group.length);
                this.currentScore += points;
                
                // 更新最高分
                if (this.currentScore > this.highestScore) {
                    this.highestScore = this.currentScore;
                }
                
                // 显示得分反馈
                this.showFeedback(`+${points}分!`);
                
                // 移除选中的星星
                for (const {row, col} of group) {
                    this.board[row][col] = null;
                }
                
                // 立即重绘棋盘
                this.drawBoard();
                
                // 应用重力效果 - 星星下落
                setTimeout(() => this.applyGravity(), 300);
                
                // 检查是否过关
                if (this.currentScore >= this.targetScore) {
                    setTimeout(() => {
                        this.showFeedback('过关!');
                        this.createParticleEffect();
                    }, 500);
                    
                    setTimeout(() => {
                        this.currentLevel++;
                        this.calculateTargetScore();
                        this.generateBoard();
                        this.drawBoard();
                    }, 1500);
                }
                
                // 更新UI
                this.updateUI();
            }
            
            calculatePoints(groupSize) {
                return groupSize * 15 + Math.pow(groupSize, 2);
            }
            
            applyGravity() {
                let changed = false;
                
                // 1. 垂直重力效果
                for (let j = 0; j < this.boardSize; j++) {
                    let emptySpot = this.boardSize - 1;
                    
                    // 从底部向上扫描该列
                    for (let i = this.boardSize - 1; i >= 0; i--) {
                        // 如果当前位置有星星
                        if (this.board[i][j] !== null) {
                            // 如果下面有空位，则下移星星
                            if (emptySpot !== i) {
                                this.board[emptySpot][j] = this.board[i][j];
                                this.board[i][j] = null;
                                changed = true;
                            }
                            emptySpot--;
                        }
                    }
                }
                
                // 2. 水平填充效果
                let emptyCol = 0;
                for (let j = 0; j < this.boardSize; j++) {
                    // 检查列是否为空 (顶部单元为空)
                    if (this.board[0][j] !== null) {
                        // 如果不是空列，将其移动到下一个空位置
                        if (emptyCol !== j) {
                            for (let i = 0; i < this.boardSize; i++) {
                                this.board[i][emptyCol] = this.board[i][j];
                                this.board[i][j] = null;
                                changed = true;
                            }
                        }
                        emptyCol++;
                    }
                }
                
                // 如果有变化，重绘棋盘
                if (changed) {
                    this.drawBoard();
                    
                    // 检查是否有新的消除组
                    setTimeout(() => this.checkForAutoEliminations(), 300);
                }
            }
            
            checkForAutoEliminations() {
                // 在消除和重力效果后检查是否有可自动消除的组
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        if (this.board[i][j] !== null) {
                            // 尝试查找同色组
                            const color = this.board[i][j];
                            let groupSize = 0;
                            
                            // 简单的横向检查
                            let k = j;
                            while (k < this.boardSize && this.board[i][k] === color) {
                                groupSize++;
                                k++;
                            }
                            
                            // 如果找到水平组
                            if (groupSize >= 2) {
                                this.removeStarGroup(i, j);
                                return;
                            }
                            
                            // 简单的纵向检查
                            groupSize = 0;
                            k = i;
                            while (k < this.boardSize && this.board[k][j] === color) {
                                groupSize++;
                                k++;
                            }
                            
                            // 如果找到垂直组
                            if (groupSize >= 2) {
                                this.removeStarGroup(i, j);
                                return;
                            }
                        }
                    }
                }
            }
            
            showFeedback(message) {
                this.feedbackElement.textContent = message;
                this.feedbackElement.classList.add('feedback-visible');
                
                setTimeout(() => {
                    this.feedbackElement.classList.remove('feedback-visible');
                }, 1500);
            }
            
            createParticleEffect() {
                if (!this.animationEnabled) return;
                
                // 清除旧的粒子
                this.specialEffectsElement.innerHTML = '';
                
                // 生成粒子效果
                for (let i = 0; i < 80; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    
                    // 随机位置
                    const centerX = this.canvas.width / 2;
                    const centerY = this.canvas.height / 2;
                    const radius = Math.min(this.canvas.width, this.canvas.height) * 0.4;
                    
                    // 随机位置和颜色
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * radius;
                    const x = centerX + Math.cos(angle) * distance;
                    const y = centerY + Math.sin(angle) * distance;
                    
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    // 随机颜色
                    const colorIndex = Math.floor(Math.random() * this.starColors.length);
                    particle.style.backgroundColor = this.starColors[colorIndex];
                    
                    // 随机大小
                    const size = 4 + Math.random() * 8;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    
                    this.specialEffectsElement.appendChild(particle);
                    
                    // 添加动画
                    setTimeout(() => {
                        particle.style.transition = 'transform 0.8s ease-out, opacity 0.8s ease-out';
                        particle.style.transform = `translate(${Math.cos(angle) * 200}px, ${Math.sin(angle) * 200}px)`;
                        particle.style.opacity = '0';
                    }, 50);
                }
                
                // 清理粒子
                setTimeout(() => {
                    this.specialEffectsElement.innerHTML = '';
                }, 1000);
            }
            
            updateUI() {
                document.getElementById('current-level').textContent = this.currentLevel;
                document.getElementById('target-score').textContent = this.targetScore;
                document.getElementById('current-score').textContent = this.currentScore;
                document.getElementById('highest-score').textContent = this.highestScore;
            }
            
            setupEventListeners() {
                // 画布点击事件
                this.canvas.addEventListener('click', (e) => this.onCanvasClick(e));
                
                // 触摸事件支持（移动端）
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = this.canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    // 模拟点击事件
                    const clickEvent = new MouseEvent('click', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(clickEvent);
                }, { passive: false });
                
                // 窗口大小改变
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                    this.drawBoard();
                });
                
                // 重置按钮
                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.resetGame();
                });
                
                // 刷新按钮
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.generateBoard();
                    this.drawBoard();
                });
                
                // 设置切换
                document.getElementById('sound-toggle').addEventListener('change', (e) => {
                    this.soundEnabled = e.target.checked;
                    this.saveGameState();
                });
                
                document.getElementById('animation-toggle').addEventListener('change', (e) => {
                    this.animationEnabled = e.target.checked;
                    this.saveGameState();
                });
                
                document.getElementById('theme-select').addEventListener('change', (e) => {
                    this.theme = e.target.value;
                    this.applyTheme();
                    this.saveGameState();
                });
            }
            
            resetGame() {
                this.currentLevel = 1;
                this.currentScore = 0;
                this.calculateTargetScore();
                this.generateBoard();
                this.updateUI();
                this.drawBoard();
                this.saveGameState();
            }
            
            applyTheme() {
                // 应用主题设置
                if (this.theme === 'light') {
                    document.body.style.background = 'linear-gradient(135deg, #f0f2f5 0%, #e3e6eb 100%)';
                } else if (this.theme === 'dark') {
                    document.body.style.background = 'linear-gradient(135deg, #1a2026 0%, #12181d 100%)';
                } else {
                    // 自动模式：检查系统偏好
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.style.background = 'linear-gradient(135deg, #1a2026 0%, #12181d 100%)';
                    } else {
                        document.body.style.background = 'linear-gradient(135deg, #f0f2f5 0%, #e3e6eb 100%)';
                    }
                }
            }
            
            saveGameState() {
                const gameState = {
                    level: this.currentLevel,
                    score: this.currentScore,
                    highestScore: this.highestScore,
                    settings: {
                        sound: this.soundEnabled,
                        animation: this.animationEnabled,
                        theme: this.theme
                    }
                };
                localStorage.setItem('starEliminationGame', JSON.stringify(gameState));
            }
            
            loadGameState() {
                const savedState = localStorage.getItem('starEliminationGame');
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    
                    this.currentLevel = gameState.level || 1;
                    this.currentScore = gameState.score || 0;
                    this.highestScore = gameState.highestScore || 0;
                    
                    if (gameState.settings) {
                        this.soundEnabled = gameState.settings.sound !== undefined ? gameState.settings.sound : true;
                        this.animationEnabled = gameState.settings.animation !== undefined ? gameState.settings.animation : true;
                        this.theme = gameState.settings.theme || 'auto';
                        
                        // 应用设置到UI
                        document.getElementById('sound-toggle').checked = this.soundEnabled;
                        document.getElementById('animation-toggle').checked = this.animationEnabled;
                        document.getElementById('theme-select').value = this.theme;
                    }
                    
                    // 应用主题
                    this.applyTheme();
                }
            }
        }
        
        // 辅助函数：颜色增亮
        function lightenColor(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            let R = (num >> 16) + amt;
            let G = (num >> 8 & 0x00FF) + amt;
            let B = (num & 0x0000FF) + amt;
            
            R = R > 255 ? 255 : R < 0 ? 0 : R;
            G = G > 255 ? 255 : G < 0 ? 0 : G;
            B = B > 255 ? 255 : B < 0 ? 0 : B;
            
            return `#${((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1)}`;
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('DOMContentLoaded', () => {
            const game = new StarEliminationGame();
        });
    </script>
</body>
</html>
