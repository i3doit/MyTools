<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PixelGuard Pro - è‰¾å…œå…œå„¿å®‰å…¨å½±åƒè„±æ•å·¥å…·</title>
    <link rel="stylesheet" href="https://lf3-static.bytecdn.cn/obj/eden-cn/h7nupe_lp_lp/harmonyos_sans.css">
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-accent: #0071e3;
            --glass: rgba(255, 255, 255, 0.75);
            --eye-care: #eef2f3;
        }

        * { box-sizing: border-box; font-family: 'HarmonyOS Sans SC', sans-serif; margin: 0; padding: 0; touch-action: none; }

        body {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            color: #1d1d1f;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; }

        /* ç”»å¸ƒä¸»åŒºåŸŸ */
        .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin: 15px;
            border-radius: 24px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        #main-canvas {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transform-origin: 0 0;
            background-color: #fff;
            image-rendering: pixelated;
        }

        /* æµ®åŠ¨å·¥å…·æ  */
        .floating-toolbar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 22px;
            display: flex;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 200;
            border: 1px solid rgba(255,255,255,0.4);
        }

        .tool-btn {
            height: 48px;
            width: 48px;
            border-radius: 16px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            overflow: hidden;
        }

        .tool-btn svg { width: 22px; height: 22px; fill: #1d1d1f; flex-shrink: 0; }
        
        /* é€‰ä¸­æ€ï¼šå±•ç¤ºæ–‡æ¡ˆ */
        .tool-btn.active { width: 130px; background: var(--apple-accent); }
        .tool-btn.active svg { fill: #fff; }
        .tool-label { color: #fff; font-size: 14px; margin-left: 10px; white-space: nowrap; display: none; }
        .tool-btn.active .tool-label { display: block; }

        /* å‚æ•°é¢æ¿ */
        .settings-card {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 20px;
            width: 240px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            display: none;
            z-index: 150;
        }

        .setting-group { margin-bottom: 15px; }
        .setting-group label { display: block; font-size: 12px; color: #6e6e73; margin-bottom: 8px; font-weight: 600; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 10px; outline: none; }
        input[type="range"] { width: 100%; accent-color: var(--apple-accent); }

        /* åˆå§‹ä¸Šä¼ é®ç½© */
        #upload-overlay {
            position: absolute;
            inset: 0;
            background: var(--apple-bg);
            z-index: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* åº•éƒ¨ç‰ˆæƒ */
        footer {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 15px;
            font-size: 12px;
            color: #6e6e73;
            text-align: center;
            line-height: 1.8;
            z-index: 100;
        }
        footer a { color: var(--apple-accent); text-decoration: none; margin: 0 5px; }

        #toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <header>
        <div class="user-info">
            <img src="https://profile-avatar.csdnimg.cn/22f8b0128b694047beb93057ddc0d7cc_kq8819.jpg!1" class="avatar">
            <strong>PixelGuard Pro è„±æ•ä¸“å®¶</strong>
        </div>
        <button class="tool-btn" style="width: auto; padding: 0 20px; background: #34c759; color: white;" onclick="downloadImg()">ä¿å­˜é«˜æ¸…å›¾</button>
    </header>

    <div class="editor-container" id="viewport">
        <div id="upload-overlay" onclick="document.getElementById('file-input').click()">
            <div style="font-size: 60px;">ğŸ“¸</div>
            <h2 style="margin-top: 20px;">å¯¼å…¥å›¾ç‰‡å¼€å§‹å®‰å…¨æ‰“ç </h2>
            <p style="color: #86868b; margin-top: 10px;">æ”¯æŒå¤šå›¾æ“ä½œ Â· çº¯æœ¬åœ°å¤„ç† Â· æ— æ³•è§£ç è¿˜åŸ</p>
            <input type="file" id="file-input" hidden accept="image/*">
        </div>

        <canvas id="main-canvas"></canvas>

        <div class="settings-card" id="settings-card">
            <div class="setting-group">
                <label>æ‰“ç åŠ›åº¦ (ç¬”è§¦å¤§å°)</label>
                <input type="range" id="brush-size" min="20" max="200" value="60">
            </div>
            <div class="setting-group">
                <label>è‡ªå®šä¹‰æ°´å°æ–‡æ¡ˆ</label>
                <input type="text" id="wm-text" value="è‰¾å…œå…œå„¿ææ•ˆå·¥å…·" onfocus="this.value=''">
            </div>
            <div class="setting-group">
                <label>æ°´å°é¢œè‰²</label>
                <input type="color" id="wm-color" value="#ffffff" style="width:100%; border:none; height:30px; background:none;">
            </div>
        </div>

        <div class="floating-toolbar">
            <button class="tool-btn active" onclick="setMode('pan', this)">
                <svg viewBox="0 0 24 24"><path d="M13 5.5V3h-2v2.5H8.5V3h-2v2.5H5V11h14V5.5h-1.5V3h-2v2.5H13zM5 13v6c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-6H5z"/></svg>
                <span class="tool-label">ç§»åŠ¨ç¼©æ”¾</span>
            </button>
            <button class="tool-btn" onclick="setMode('mosaic', this)">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h4v4H7V7zm6 6h4v4h-4v-4z"/></svg>
                <span class="tool-label">æ¶‚æŠ¹æ‰“ç </span>
            </button>
            <button class="tool-btn" onclick="setMode('watermark', this)">
                <svg viewBox="0 0 24 24"><path d="M21 15h2v2h-2v-2zm0-4h2v2h-2v-2zm2 8h-2v2c1 0 2-1 2-2zM13 3h2v2h-2V3zm8 4h2v2h-2V7zm0-4c1 0 2 1 2 2h-2V3zM3 3h2v2H3V3zm0 18H1c0 1 1 2 2 2v-2zm6 0h2v2H9v-2zm10-2v2h-2v-2h2zm-10-4h2v2H9v-2zM5 7v10h10V7H5zm8 8H7V9h6v6z"/></svg>
                <span class="tool-label">æ·»åŠ æ°´å°</span>
            </button>
            <div style="width:1px; background:rgba(0,0,0,0.1); margin: 8px 2px;"></div>
            <button class="tool-btn" onclick="undo()" title="è¿”å›ä¸Šä¸€æ­¥">
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button class="tool-btn" onclick="resetView()" title="é‡ç½®ä½ç½®">
                <svg viewBox="0 0 24 24"><path d="M15 3l2.3 2.3-2.89 2.87 1.42 1.42L18.7 6.7 21 9V3zM3 9l2.3-2.3 2.87 2.89 1.42-1.42L6.7 5.3 9 3H3zm6 12l-2.3-2.3 2.89-2.87-1.42-1.42L5.3 17.3 3 15v6z"/></svg>
            </button>
        </div>
    </div>

    <footer>
        <p>Â© <span id="year"></span> è‰¾å…œå…œå„¿ | <span onclick="copyQQ('857023577')" style="cursor:pointer; color:var(--apple-accent)">AIææ•ˆå®˜æ–¹ç¾¤ï¼š857023577 (ç‚¹å‡»å¤åˆ¶)</span></p>
        <div>
            <a href="https://t.zsxq.com/7tSuP" target="_blank">æŠ€æœ¯æ”¯æŒ</a> |
            <a href="https://t.zsxq.com/XNHXs" target="_blank">DeepSeekå®æˆ˜</a> |
            <a href="https://t.zsxq.com/uqG2N" target="_blank">AIç¼–ç¨‹</a> |
            <a href="https://mp.weixin.qq.com/s/uHh9gx2sUMOOjIhKyIbx4A" target="_blank">æ›´å¤šå·¥å…·</a>
        </div>
        <div style="margin-top:5px; opacity:0.6">ç´¯è®¡è®¿é—® (IP): <span id="pv-count">æ­£åœ¨ç»Ÿè®¡...</span></div>
    </footer>

    <script>
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const viewport = document.getElementById('viewport');
        const fileInput = document.getElementById('file-input');
        
        let img = new Image();
        let scale = 1, offsetX = 0, offsetY = 0;
        let mode = 'pan';
        let isDrawing = false;
        let history = [];

        // åˆå§‹åŒ–ï¼šå¹´ä»½ä¸PV
        const curYear = new Date().getFullYear();
        document.getElementById('year').innerText = curYear > 2026 ? `2026-${curYear}` : '2026';
        let pv = localStorage.getItem('pixelguard_pv') || Math.floor(Math.random()*500 + 100);
        pv = parseInt(pv) + 1;
        localStorage.setItem('pixelguard_pv', pv);
        document.getElementById('pv-count').innerText = pv;

        // æ–‡ä»¶åŠ è½½
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                img.src = ev.target.result;
                img.onload = () => {
                    document.getElementById('upload-overlay').style.display = 'none';
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    saveHistory();
                    resetView();
                };
            };
            reader.readAsDataURL(file);
        };

        // æ ¸å¿ƒï¼šç¼©æ”¾ä¸å¹³ç§» (ä»…é™å›¾ç‰‡)
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const rect = viewport.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            offsetX = mx - (mx - offsetX) * delta;
            offsetY = my - (my - offsetY) * delta;
            scale *= delta;
            updateTransform();
        }, { passive: false });

        function updateTransform() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        function resetView() {
            const r = Math.min(viewport.offsetWidth/canvas.width, viewport.offsetHeight/canvas.height);
            scale = r * 0.85;
            offsetX = (viewport.offsetWidth - canvas.width * scale) / 2;
            offsetY = (viewport.offsetHeight - canvas.height * scale) / 2;
            updateTransform();
            showToast("è§†å›¾å·²å¤ä½");
        }

        // æ¨¡å¼åˆ‡æ¢
        function setMode(m, btn) {
            mode = m;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('settings-card').style.display = (m === 'pan') ? 'none' : 'block';
            canvas.style.cursor = m === 'pan' ? 'grab' : (m === 'mosaic' ? 'crosshair' : 'copy');
        }

        // äº¤äº’é€»è¾‘
        viewport.onmousedown = (e) => {
            isDrawing = true;
            if(mode === 'mosaic') doMosaic(e);
            if(mode === 'watermark') addWM(e);
        };

        window.onmousemove = (e) => {
            if(!isDrawing) return;
            if(mode === 'pan') {
                offsetX += e.movementX;
                offsetY += e.movementY;
                updateTransform();
            } else if(mode === 'mosaic') {
                doMosaic(e);
            }
        };

        window.onmouseup = () => {
            if(isDrawing && (mode === 'mosaic' || mode === 'watermark')) saveHistory();
            isDrawing = false;
        };

        function getImgCoords(e) {
            const rect = viewport.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left - offsetX) / scale,
                y: (e.clientY - rect.top - offsetY) / scale
            };
        }

        function doMosaic(e) {
            const pos = getImgCoords(e);
            const size = parseInt(document.getElementById('brush-size').value);
            const mSize = size / 5; // é©¬èµ›å…‹å—å¤§å°
            const sx = pos.x - size/2, sy = pos.y - size/2;
            
            try {
                const imgData = ctx.getImageData(sx, sy, size, size);
                const d = imgData.data;
                for(let y=0; y<size; y+=mSize) {
                    for(let x=0; x<size; x+=mSize) {
                        const i = (Math.floor(y)*size + Math.floor(x))*4;
                        ctx.fillStyle = `rgb(${d[i]},${d[i+1]},${d[i+2]})`;
                        ctx.fillRect(sx+x, sy+y, mSize+1, mSize+1);
                    }
                }
            } catch(e){}
        }

        function addWM(e) {
            const pos = getImgCoords(e);
            const txt = document.getElementById('wm-text').value;
            if(!txt) return;
            ctx.save();
            ctx.font = `bold ${canvas.width/30}px HarmonyOS Sans SC`;
            ctx.fillStyle = document.getElementById('wm-color').value;
            ctx.globalAlpha = 0.5;
            ctx.fillText(txt, pos.x, pos.y);
            ctx.restore();
        }

        // æ’¤é”€åŠŸèƒ½
        function saveHistory() {
            if(history.length > 20) history.shift();
            history.push(canvas.toDataURL());
        }

        function undo() {
            if(history.length <= 1) return showToast("æ— æ³•ç»§ç»­æ’¤é”€");
            history.pop();
            const prev = new Image();
            prev.src = history[history.length - 1];
            prev.onload = () => {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.drawImage(prev, 0, 0);
                showToast("å·²å›é€€ä¸€æ­¥");
            };
        }

        // è¾…åŠ©
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function copyQQ(num) {
            navigator.clipboard.writeText(num);
            showToast("QQç¾¤å·å·²å¤åˆ¶ ğŸš€");
        }

        function downloadImg() {
            const link = document.createElement('a');
            link.download = `PixelGuard_Export_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            showToast("é«˜æ¸…å›¾ç‰‡å·²ä¿å­˜è‡³æœ¬åœ°");
        }
    </script>
</body>
</html>
