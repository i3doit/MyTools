<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PixelGuard Pro - è‰¾å…œå…œå„¿å®‰å…¨å½±åƒè„±æ•å·¥å…·</title>
    <link rel="stylesheet" href="https://lf3-static.bytecdn.cn/obj/eden-cn/h7nupe_lp_lp/harmonyos_sans.css">
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-accent: #0071e3;
            --glass: rgba(255, 255, 255, 0.8);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; font-family: 'HarmonyOS Sans SC', sans-serif; margin: 0; padding: 0; touch-action: none; }

        body {
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ç¦æ­¢æ•´é¡µæ»šåŠ¨ */
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        /* ä¸»ç”»å¸ƒåŒº - æ’‘æ»¡å‰©ä½™ç©ºé—´ */
        .editor-main {
            flex: 1;
            position: relative;
            background: #e5e5e7;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #main-canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background: #fff;
            cursor: grab;
            transition: transform 0.1s ease-out;
        }

        /* æµ®åŠ¨å·¥å…·æ  - è‹¹æœå®˜ç½‘é£ */
        .floating-toolbar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 20px;
            display: flex;
            gap: 8px;
            box-shadow: var(--card-shadow);
            z-index: 200;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .tool-btn svg { width: 22px; height: 22px; fill: #1d1d1f; flex-shrink: 0; }
        
        /* é€‰ä¸­æ€æ–‡æ¡ˆæ˜¾ç¤º */
        .tool-btn.active {
            width: 110px;
            background: var(--apple-accent);
        }
        .tool-btn.active svg { fill: #fff; }
        .tool-label {
            color: #fff;
            font-size: 13px;
            margin-left: 8px;
            white-space: nowrap;
            opacity: 0;
            display: none;
        }
        .tool-btn.active .tool-label { display: block; opacity: 1; }

        .tool-btn:hover:not(.active) { background: rgba(0,0,0,0.05); }

        /* å‚æ•°è°ƒæ•´é¢æ¿ */
        .settings-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 18px;
            box-shadow: var(--card-shadow);
            width: 220px;
            display: none;
        }

        .setting-item { margin-bottom: 12px; }
        .setting-item label { font-size: 11px; color: #86868b; display: block; margin-bottom: 5px; }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 13px;
        }

        /* åˆå§‹ä¸Šä¼  */
        #upload-overlay {
            position: absolute;
            inset: 0;
            background: #f5f5f7;
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 1000;
            display: none;
        }

        footer { position: absolute; bottom: 0; width: 100%; padding: 5px; font-size: 10px; text-align: center; color: #86868b; z-index: 50; pointer-events: none; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <header>
        <div class="user-info">
            <img src="https://profile-avatar.csdnimg.cn/22f8b0128b694047beb93057ddc0d7cc_kq8819.jpg!1" class="avatar">
            <span style="font-weight: 600;">PixelGuard Pro</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="tool-btn" style="width: auto; padding: 0 15px; background: #34c759; color: white;" onclick="downloadImage()">ä¿å­˜é«˜æ¸…åŸå›¾</button>
        </div>
    </header>

    <div class="editor-main" id="viewport">
        <div id="upload-overlay" onclick="document.getElementById('file-input').click()">
            <div style="font-size: 40px;">ğŸ“‚</div>
            <h3 style="margin-top: 15px;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</h3>
            <p style="color: #86868b; font-size: 13px;">é«˜æ¸…æ‰“ç  Â· å±€éƒ¨ç¼©æ”¾ Â· å®‰å…¨å¯¼å‡º</p>
            <input type="file" id="file-input" hidden accept="image/*">
        </div>

        <canvas id="main-canvas"></canvas>

        <div class="settings-panel" id="settings-panel">
            <div class="setting-item">
                <label>æ‰“ç åŠå¾„ / ç¬”è§¦</label>
                <input type="range" id="brush-size" min="10" max="150" value="50" style="width:100%">
            </div>
            <div class="setting-item">
                <label>è‡ªå®šä¹‰æ°´å°æ–‡æ¡ˆ</label>
                <input type="text" id="wm-text" value="ä»…ä¾›æ ¡éªŒä½¿ç”¨" onfocus="this.value=''">
            </div>
            <div class="setting-item">
                <label>æ°´å°é¢œè‰²</label>
                <input type="color" id="wm-color" value="#ffffff" style="width:100%; height:30px; border:none; background:none;">
            </div>
        </div>

        <div class="floating-toolbar" id="toolbar">
            <button class="tool-btn active" onclick="setMode('pan', this)" title="ç§»åŠ¨ä¸ç¼©æ”¾">
                <svg viewBox="0 0 24 24"><path d="M13 5.5V3h-2v2.5H8.5V3h-2v2.5H5V11h14V5.5h-1.5V3h-2v2.5H13zM5 13v6c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-6H5z"/></svg>
                <span class="tool-label">ç§»åŠ¨ç¼©æ”¾</span>
            </button>
            <button class="tool-btn" onclick="setMode('mosaic', this)" title="æ¶‚æŠ¹æ‰“ç ">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h4v4H7V7zm6 6h4v4h-4v-4z"/></svg>
                <span class="tool-label">å±€éƒ¨æ‰“ç </span>
            </button>
            <button class="tool-btn" onclick="setMode('watermark', this)" title="æ·»åŠ æ°´å°">
                <svg viewBox="0 0 24 24"><path d="M21 15h2v2h-2v-2zm0-4h2v2h-2v-2zm2 8h-2v2c1 0 2-1 2-2zM13 3h2v2h-2V3zm8 4h2v2h-2V7zm0-4c1 0 2 1 2 2h-2V3zM1 7h2v2H1V7zm16-4h2v2h-2V3zm0 18h2v2h-2v-2zM3 3h2v2H3V3zm0 18H1c0 1 1 2 2 2v-2zm6 0h2v2H9v-2zm10-2v2h-2v-2h2zm-10-4h2v2H9v-2zm10-4h2v2h-2v-2zM5 7v10h10V7H5zm8 8H7V9h6v6zM1 19h2v2H1v-2zm0-4h2v2H1v-2zm0-4h2v2H1v-2zm0-4h2v2H1v-2zm0-4h2v2H1v-2z"/></svg>
                <span class="tool-label">è‡ªç”±æ°´å°</span>
            </button>
            <div style="width:1px; background:rgba(0,0,0,0.1); margin: 5px 2px;"></div>
            <button class="tool-btn" onclick="undo()" title="è¿”å›ä¸Šä¸€æ­¥">
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button class="tool-btn" onclick="resetView()" title="æ¢å¤åˆå§‹å¤§å°">
                <svg viewBox="0 0 24 24"><path d="M15 3l2.3 2.3-2.89 2.87 1.42 1.42L18.7 6.7 21 9V3zM3 9l2.3-2.3 2.87 2.89 1.42-1.42L6.7 5.3 9 3H3zm6 12l-2.3-2.3 2.89-2.87-1.42-1.42L5.3 17.3 3 15v6zm12-6l-2.3 2.3-2.87-2.89-1.42 1.42 2.89 2.87L15 21h6z"/></svg>
            </button>
        </div>
    </div>

    <footer>
        Â© <span id="year"></span> è‰¾å…œå…œå„¿ | æŠ€æœ¯æ”¯æŒï¼š857023577 | æµè§ˆé‡ï¼š<span id="pv">1289</span>
    </footer>

    <script>
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const viewport = document.getElementById('viewport');
        const fileInput = document.getElementById('file-input');
        
        let originalImg = new Image();
        let scale = 1, offsetX = 0, offsetY = 0;
        let isMoving = false, isPainting = false;
        let mode = 'pan';
        let historyStack = []; // æ’¤é”€æ ˆ

        // 1. åˆå§‹åŒ–
        document.getElementById('year').innerText = new Date().getFullYear();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                originalImg.src = ev.target.result;
                originalImg.onload = () => {
                    document.getElementById('upload-overlay').style.display = 'none';
                    canvas.width = originalImg.width;
                    canvas.height = originalImg.height;
                    ctx.drawImage(originalImg, 0, 0);
                    saveState(); // ä¿å­˜åˆå§‹çŠ¶æ€
                    resetView();
                };
            };
            reader.readAsDataURL(file);
        };

        function setMode(newMode, btn) {
            mode = newMode;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('settings-panel').style.display = (mode === 'pan') ? 'none' : 'block';
            canvas.style.cursor = mode === 'pan' ? 'grab' : (mode === 'mosaic' ? 'crosshair' : 'copy');
        }

        // 2. å±€éƒ¨ç¼©æ”¾é€»è¾‘ (éš”ç¦»é¡µé¢)
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault(); // ç¦æ­¢æ•´é¡µç¼©æ”¾
            const zoom = e.deltaY > 0 ? 0.9 : 1.1;
            const rect = viewport.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            offsetX = mouseX - (mouseX - offsetX) * zoom;
            offsetY = mouseY - (mouseY - offsetY) * zoom;
            scale *= zoom;
            applyTransform();
        }, { passive: false });

        function applyTransform() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        function resetView() {
            const ratio = Math.min(viewport.offsetWidth / canvas.width, viewport.offsetHeight / canvas.height);
            scale = ratio * 0.8;
            offsetX = (viewport.offsetWidth - canvas.width * scale) / 2;
            offsetY = (viewport.offsetHeight - canvas.height * scale) / 2;
            applyTransform();
            showToast("è§†å›¾å·²å¤ä½");
        }

        // 3. ç»˜å›¾ä¸æ“ä½œ
        viewport.onmousedown = (e) => {
            if(mode === 'pan') {
                isMoving = true;
                canvas.style.cursor = 'grabbing';
            } else if(mode === 'mosaic') {
                isPainting = true;
                paint(e);
            } else if(mode === 'watermark') {
                addText(e);
            }
        };

        window.onmousemove = (e) => {
            if(isMoving) {
                offsetX += e.movementX;
                offsetY += e.movementY;
                applyTransform();
            } else if(isPainting) {
                paint(e);
            }
        };

        window.onmouseup = () => {
            if(isPainting) saveState(); // åœæ­¢æ¶‚æŠ¹æ—¶å­˜å…¥å†å²
            isMoving = false;
            isPainting = false;
            canvas.style.cursor = mode === 'pan' ? 'grab' : (mode === 'mosaic' ? 'crosshair' : 'copy');
        };

        function getCoord(e) {
            const rect = viewport.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left - offsetX) / scale,
                y: (e.clientY - rect.top - offsetY) / scale
            };
        }

        function paint(e) {
            const pos = getCoord(e);
            const size = parseInt(document.getElementById('brush-size').value);
            const m = size / 5; // å—å¤§å°
            const sx = pos.x - size/2, sy = pos.y - size/2;
            
            try {
                const data = ctx.getImageData(sx, sy, size, size).data;
                for(let y=0; y<size; y+=m) {
                    for(let x=0; x<size; x+=m) {
                        const i = (Math.floor(y)*size + Math.floor(x))*4;
                        ctx.fillStyle = `rgb(${data[i]},${data[i+1]},${data[i+2]})`;
                        ctx.fillRect(sx+x, sy+y, m+1, m+1);
                    }
                }
            } catch(e){}
        }

        function addText(e) {
            const pos = getCoord(e);
            const txt = document.getElementById('wm-text').value;
            if(!txt) return;
            ctx.font = `${canvas.width/35}px HarmonyOS Sans SC`;
            ctx.fillStyle = document.getElementById('wm-color').value;
            ctx.globalAlpha = 0.6;
            ctx.fillText(txt, pos.x, pos.y);
            ctx.globalAlpha = 1.0;
            saveState();
        }

        // 4. å†å²è®°å½• (æ’¤é”€)
        function saveState() {
            if(historyStack.length > 20) historyStack.shift();
            historyStack.push(canvas.toDataURL());
        }

        function undo() {
            if(historyStack.length <= 1) return showToast("å·²ç»æ˜¯æœ€æ—©çš„ä¸€æ­¥äº†");
            historyStack.pop(); // å¼¹å‡ºå½“å‰
            const img = new Image();
            img.src = historyStack[historyStack.length - 1];
            img.onload = () => {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                showToast("å·²æ’¤é”€");
            };
        }

        // 5. å…¶ä»–å·¥å…·
        function downloadImage() {
            const link = document.createElement('a');
            link.download = `PixelGuard_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function copyText(s){ navigator.clipboard.writeText(s); showToast("å¤åˆ¶æˆåŠŸ"); }
    </script>
</body>
</html>
